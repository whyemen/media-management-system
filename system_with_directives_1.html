<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة العمليات الإعلامية</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* إخفاء جميع الأقسام بشكل افتراضي */
        .dashboard,
        #socialMediaSection,
        #digitalContentSection,
        #tvBroadcastSection,
        #dataAnalysisSection,
        #contentPlanningSection,
        #publishingSection,
        #consultingSection,
        #reportsSection {
            display: none;
        }

        /* إظهار قسم تسجيل الدخول فقط */
        #loginSection {
            display: block;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
        }

        .login-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .login-btn, .submit-btn, .action-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover, .submit-btn:hover, .action-btn:hover {
            transform: translateY(-2px);
        }

        .dashboard {
            display: none;
        }

        #loginSection {
            display: block;
        }

        .dashboard.active {
            display: block;
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h3 {
            color: white;
            margin: 0;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Enhanced Director Dashboard Styles */
        .director-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .notifications-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .notifications-title {
            font-size: 1.5rem;
            color: #333;
            font-weight: 700;
        }

        .notification-counter {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .notification-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-right: 4px solid #667eea;
            transition: transform 0.2s;
        }

        .notification-item:hover {
            transform: translateX(-5px);
        }

        .notification-item.urgent {
            border-right-color: #ff4757;
            background: #fff5f5;
        }

        .notification-item.medium {
            border-right-color: #ffa502;
            background: #fffbf0;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-source {
            font-weight: 600;
            color: #333;
        }

        .notification-time {
            font-size: 12px;
            color: #666;
        }

        .notification-content {
            color: #555;
            line-height: 1.4;
        }

        .notification-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .notification-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin: 0 4px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .notification-btn:active {
            transform: scale(0.95);
        }

        .notification-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .notification-btn:active::before {
            width: 100px;
            height: 100px;
        }

        .approve-btn {
            background: #2ed573;
            color: white;
        }

        .reject-btn {
            background: #ff4757;
            color: white;
        }

        .consult-btn {
            background: #3742fa;
            color: white;
        }

        .notification-btn:hover {
            transform: translateY(-1px);
        }

        .workflow-status {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .workflow-title {
            font-size: 1.5rem;
            color: #333;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .workflow-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }

        .step-circle.completed {
            background: #2ed573;
        }

        .step-circle.active {
            background: #3742fa;
        }

        .step-circle.pending {
            background: #a4b0be;
        }

        .step-label {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .workflow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 25px;
            right: -50px;
            width: 100px;
            height: 2px;
            background: #e1e5e9;
        }

        .workflow-step.completed:not(:last-child)::after {
            background: #2ed573;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .module-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .module-card:hover {
            transform: translateY(-5px);
        }

        .module-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .module-card p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        /* Enhanced Analyst Dashboard */
        .analyst-dashboard {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .monitoring-data {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .monitoring-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-right: 4px solid #667eea;
        }

        .monitoring-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .monitoring-source {
            font-weight: 600;
            color: #333;
        }

        .monitoring-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
        }

        .detail-value {
            color: #333;
        }

        .monitoring-content {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-style: italic;
        }

        .start-analysis-btn {
            background: #3742fa;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .inbox-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workflow-status {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .workflow-status h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 18px;
        }

        .workflow-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .workflow-step.completed {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .workflow-step.active {
            background: linear-gradient(135deg, #3498db, #5dade2);
            color: white;
            transform: scale(1.02);
        }

        .workflow-step:not(.completed):not(.active) {
            background: #f8f9fa;
            border: 2px dashed #bdc3c7;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-left: 15px;
            background: rgba(255,255,255,0.2);
        }

        .workflow-step:not(.completed):not(.active) .step-number {
            background: #95a5a6;
            color: white;
        }

        .step-label {
            font-weight: 500;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .manage-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
        }

        .manage-btn:hover {
            background: #218838;
        }

        .monitor-actions {
            display: flex;
            align-items: center;
        }

        .media-management-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .add-media-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .add-btn {
            background: #28a745;
        }

        /* CSS للتجميع الجديد */
        .monitoring-type-section {
            margin-bottom: 25px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
        }

        .monitoring-type-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #e1e5e9;
        }

        .monitoring-type-content {
            padding: 15px;
        }

        .monitoring-entity-section {
            margin-bottom: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            overflow: hidden;
        }

        .monitoring-entity-header {
            background: #f8f9fa;
            color: #333;
            padding: 12px 15px;
            margin: 0;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 1px solid #e1e5e9;
        }

        .monitoring-entity-content {
            padding: 10px;
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge.priority-high {
            background: #ff4757;
            color: white;
        }

        .priority-badge.priority-medium {
            background: #ffa502;
            color: white;
        }

        .priority-badge.priority-low {
            background: #2ed573;
            color: white;
        }
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            height: fit-content;
        }

        .add-btn:hover {
            background: #218838;
        }

        .media-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .media-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .media-info {
            flex: 1;
        }

        .media-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .media-entity {
            font-size: 14px;
            color: #666;
        }

        .media-actions {
            display: flex;
            gap: 10px;
        }

        .edit-media-btn, .delete-media-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-media-btn {
            background: #ffa502;
            color: white;
        }

        .delete-media-btn {
            background: #ff4757;
            color: white;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .monitor-actions {
                flex-direction: column;
                gap: 10px;
            }
        }  
        
        .consultation-modal {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            margin: 10% auto;
            max-height: 80vh;
            overflow-y: auto;
        }

        .department-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .department-btn {
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .department-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .department-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .entity-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .entity-input-group input {
            flex: 1;
        }

        .edit-btn {
            background: #ffa502;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .director-dashboard {
                grid-template-columns: 1fr;
            }
            
            .workflow-steps {
                flex-direction: column;
                gap: 20px;
            }
            
            .workflow-step:not(:last-child)::after {
                display: none;
            }
        }

        /* Web Monitor Dashboard Styles */
        .web-monitor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 15px 15px 0 0;
        }

        .main-title {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }

        .header-buttons {
            display: flex;
            gap: 15px;
        }

        .media-management-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .media-management-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .web-monitor-content {
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: calc(100vh - 200px);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .monitor-main-card {
            background: white;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 100%;
        }

        .card-title {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .card-description {
            font-size: 18px;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .start-monitoring-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 300px;
        }

        .start-monitoring-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* Director Dashboard - New Vertical Layout */
        .director-main-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: calc(100vh - 150px);
        }

        .inbox-section-top {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .bottom-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .workflow-section-compact {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stats-section-compact {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .workflow-section-compact h3,
        .stats-section-compact h3 {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .workflow-steps-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }

        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-circle-small {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            background: #6c757d;
        }

        .workflow-step.completed .step-circle-small {
            background: #28a745;
        }

        .workflow-step.active .step-circle-small {
            background: #007bff;
            box-shadow: 0 0 15px rgba(0,123,255,0.5);
        }

        .step-label-small {
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            color: #495057;
        }

        .stats-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card-compact {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .stat-card-compact .stat-number {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card-compact .stat-label {
            font-size: 11px;
            opacity: 0.9;
        }

        .inbox-section-right {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .inbox-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .inbox-header h3 {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .notification-count {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 5px 10px;
            font-size: 14px;
            font-weight: bold;
        }

        .notification-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }

        .notification-item.priority-high {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .notification-item.priority-medium {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .notification-item.priority-normal {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-title {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .notification-time {
            font-size: 12px;
            color: #666;
        }

        .notification-text {
            color: #555;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.approve {
            background: #28a745;
            color: white;
        }

        .action-btn.reject {
            background: #dc3545;
            color: white;
        }

        .action-btn.consult {
            background: #17a2b8;
            color: white;
        }

        .action-btn.review {
            background: #6f42c1;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Custom Select Styling - Alternative Solution */
        select option[value*="---"] {
            background: #f0f0f0 !important;
            color: #333 !important;
            font-weight: bold !important;
            font-style: italic !important;
            padding: 8px !important;
        }

        /* Category headers styling */
        select option[disabled] {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe) !important;
            color: white !important;
            font-weight: bold !important;
            text-align: center !important;
            padding: 10px !important;
        }

        /* Custom Select Dropdown */
        .custom-select-container {
            position: relative;
            width: 100%;
        }

        .custom-select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 20px;
        }

        .custom-select:hover {
            border-color: #6c5ce7;
        }

        .custom-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .custom-options.show {
            display: block;
        }

        .option-category {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            font-weight: bold;
            padding: 10px 15px;
            text-align: center;
            font-size: 14px;
            margin: 2px 0;
        }

        .option-category.blue {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .option-category.red {
            background: linear-gradient(135deg, #FF5722, #E64A19);
        }

        .option-category.orange {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }

        .option-category.purple {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        }

        .option-category.gray {
            background: linear-gradient(135deg, #607D8B, #455A64);
        }

        .option-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .option-item:hover {
            background-color: #f8f9fa;
        }

        .option-item:last-child {
            border-bottom: none;
        }

        .dropdown-arrow {
            transition: transform 0.2s;
        }

        .custom-select.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .cancel-btn:hover {
            background: #5a6268;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .bottom-section {
                flex-direction: column;
            }
            
            .workflow-steps-compact {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .stats-grid-compact {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .step-circle-small {
                width: 40px;
                height: 40px;
                font-size: 12px;
            }
            
            .step-label-small {
                font-size: 10px;
            }
            
            .notification-actions {
                justify-content: center;
            }
        }

        /* تصميم واجهة مسؤولي المسارات - ألوان رسمية */
        .path-manager-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
            padding: 25px;
            direction: rtl;
        }

        .received-directives-section,
        .assignment-form-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            direction: rtl;
        }

        .received-directives-section h3,
        .assignment-form-section h3 {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #34495e;
            text-align: right;
        }

        .assignment-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            direction: rtl;
        }

        .assignment-header {
            background: #34495e;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            direction: rtl;
        }

        .assignment-header h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            text-align: right;
        }

        .delete-assignment-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }

        .delete-assignment-btn:hover {
            background: #c0392b;
        }

        .assignment-form {
            padding: 20px;
            direction: rtl;
            text-align: right;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 18px;
            direction: rtl;
            text-align: right;
        }

        .form-group {
            flex: 1;
            margin-bottom: 18px;
            direction: rtl;
            text-align: right;
        }

        .form-group.full-width {
            flex: 1;
        }

        .form-group.half-width {
            flex: 1;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 15px;
            text-align: right;
            direction: rtl;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            background: #ffffff;
            transition: all 0.3s ease;
            direction: rtl;
            text-align: right;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s;
            background: white;
            box-sizing: border-box;
            direction: rtl;
            text-align: right;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 90px;
            font-family: inherit;
            direction: rtl;
            text-align: right;
        }

        .form-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
            margin-top: 20px;
            direction: rtl;
        }

        .action-btn,
        .submit-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn {
            background: #95a5a6;
            color: white;
        }

        .action-btn:hover {
            background: #7f8c8d;
        }

        .submit-btn {
            background: #27ae60;
            color: white;
        }

        .submit-btn:hover {
            background: #229954;
        }

        /* تحسين المساحات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .path-manager-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .form-row {
                flex-direction: column;
                gap: 15px;
            }

            .form-buttons {
                flex-direction: column;
            }

            .action-btn,
            .submit-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>نظام إدارة العمليات الإعلامية</h1>
            <p>نظام متكامل لإدارة الرصد والتحليل والإنتاج والنشر</p>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="login-container">
            <h2>تسجيل الدخول</h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>اسم المستخدم:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>كلمة المرور:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="login-btn">دخول</button>
            </form>
        </div>

        <!-- Enhanced Director Dashboard -->
        <div id="directorDashboard" class="dashboard">
            <div class="user-info">
                <h3 id="directorName">قيادة الدائرة</h3>
                <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
            </div>

            <div class="director-main-layout">
                <!-- Inbox Section (Top) -->
                <div class="inbox-section-top">
                    <div class="inbox-header">
                        <h3>صندوق الوارد <span id="notificationCounter" class="notification-count">5</span></h3>
                    </div>
                    <div id="notificationsList" class="inbox-content">
                        <!-- سيتم تحميل الإشعارات ديناميكياً هنا -->
                    </div>
                </div>

                <!-- Bottom Section with Workflow and Stats -->
                <div class="bottom-section">
                    <!-- Workflow Section (Left) -->
                    <div class="workflow-section-compact">
                        <h3>مسار العمل الحالي</h3>
                        <div class="workflow-steps-compact">
                            <div class="workflow-step completed">
                                <div class="step-circle-small">5</div>
                                <div class="step-label-small">الرصد</div>
                            </div>
                            <div class="workflow-step completed">
                                <div class="step-circle-small">8</div>
                                <div class="step-label-small">الإنتاج</div>
                            </div>
                            <div class="workflow-step active">
                                <div class="step-circle-small">12</div>
                                <div class="step-label-small">الموافقة</div>
                            </div>
                            <div class="workflow-step">
                                <div class="step-circle-small">3</div>
                                <div class="step-label-small">التحليل</div>
                            </div>
                            <div class="workflow-step">
                                <div class="step-circle-small">25</div>
                                <div class="step-label-small">النشر</div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Section (Right) -->
                    <div class="stats-section-compact">
                        <h3>الإحصائيات</h3>
                        <div class="stats-grid-compact">
                            <div class="stat-card-compact">
                                <div class="stat-number">8</div>
                                <div class="stat-label">استشارات واردة</div>
                            </div>
                            <div class="stat-card-compact">
                                <div class="stat-number">12</div>
                                <div class="stat-label">موجهات معلقة</div>
                            </div>
                            <div class="stat-card-compact">
                                <div class="stat-number">3</div>
                                <div class="stat-label">مشاريع بسيطة</div>
                            </div>
                            <div class="stat-card-compact">
                                <div class="stat-number">25</div>
                                <div class="stat-label">تقارير يومية</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Analyst Dashboard -->
        <div id="analystDashboard" class="dashboard">
            <div class="user-info">
                <h3 id="analystName">المحلل</h3>
                <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
            </div>

            <div class="analyst-dashboard">
                <h3>البيانات المرصودة للتحليل</h3>
                <div class="monitoring-data" id="monitoringData">
                    <!-- Monitoring data will be populated here -->
                </div>

                <form onsubmit="submitAnalysis(event)">
                    <h3>نموذج التحليل</h3>
                    <div class="form-group">
                        <label>رقم المحتوى:</label>
                        <input type="text" id="analysisId" value="MON-2024-015" readonly>
                    </div>
                                   <div class="analysis-section">
                    <h3>كتابة التحليل</h3>
                    <div class="form-group">
                        <label>رقم المحتوى المرصود:</label>
                        <input type="text" id="analysisId" readonly>
                    </div>
                    <div class="form-group">
                        <label>التحليل:</label>
                        <textarea id="analysisText" rows="8" placeholder="اكتب تحليلك هنا..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>التوصيات:</label>
                        <textarea id="recommendations" rows="4" placeholder="اكتب توصياتك هنا..."></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="submit-btn" onclick="submitAnalysis()">إرسال التحليل</button>
                        <button class="action-btn" onclick="exportToPDF()" style="background: #e74c3c;">تصدير إلى PDF</button>
                    </div>
                </div>      </form>
            </div>
        </div>

        <!-- Path Manager Dashboard -->
        <div id="pathManagerDashboard" class="dashboard">
            <div class="user-info">
                <h3 id="pathManagerName">مسؤول المسار</h3>
                <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
            </div>

            <div class="path-manager-content">
                <!-- الموجهات المستلمة -->
                <div class="received-directives-section">
                    <h3>الموجهات المستلمة</h3>
                    <div class="directives-list" id="receivedDirectivesList">
                        <!-- سيتم تحديث هذه القائمة ديناميكياً -->
                    </div>
                </div>

                <!-- نموذج إنشاء التكاليف -->
                <div class="assignment-form-section">
                    <h3>إنشاء التكاليف</h3>
                    <div class="assignments-container" id="assignmentsContainer">
                        <!-- التكليف الأول -->
                        <div class="assignment-item" id="assignment-1">
                            <div class="assignment-header">
                                <h4>التكليف الأول</h4>
                            </div>
                            <div class="assignment-form">
                                <div class="form-group">
                                    <label>نص التكليف:</label>
                                    <textarea rows="3" placeholder="اكتب نص التكليف هنا..." required></textarea>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>الجهة المنفذة:</label>
                                        <input type="text" placeholder="أدخل اسم الجهة المنفذة" required>
                                    </div>
                                    <div class="form-group">
                                        <label>زمن التنفيذ:</label>
                                        <input type="datetime-local" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>مستوى النشر:</label>
                                        <select required>
                                            <option value="">اختر مستوى النشر</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>نوع الوسيلة:</label>
                                        <select class="media-type-select" onchange="updateMediaOptionsNew(this)" required>
                                            <option value="">اختر نوع الوسيلة</option>
                                            <option value="تلفزيوني">تلفزيوني</option>
                                            <option value="موقع">موقع</option>
                                            <option value="شبكات اجتماعية">شبكات اجتماعية</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>الوسيلة:</label>
                                    <select class="specific-media-select" required>
                                        <option value="">اختر الوسيلة</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button type="button" class="action-btn" onclick="addNewAssignment()">إضافة تكليف آخر</button>
                        <button type="button" class="submit-btn" onclick="submitAllAssignments()">إرسال جميع التكاليف</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Social Monitor Dashboard -->
        <div id="socialDashboard" class="dashboard">
            <div class="web-monitor-header">
                <h1 class="main-title">راصد الشبكات الاجتماعية</h1>
                <div class="header-buttons">
                    <button class="media-management-btn" onclick="openMediaManagement()">إدارة الوسائل</button>
                    <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
                </div>
            </div>

            <div class="web-monitor-content">
                <div class="monitor-main-card">
                    <h2 class="card-title">رصد الشبكات الاجتماعية</h2>
                    <p class="card-description">رصد ومتابعة المحتوى على منصات التواصل الاجتماعي</p>
                    <button class="start-monitoring-btn" onclick="openSocialModal()">بدء الرصد</button>
                </div>
            </div>
        </div>

        <!-- Web Monitor Dashboard -->
        <div id="webDashboard" class="dashboard">
            <div class="web-monitor-header">
                <h1 class="main-title">راصد المواقع الإلكترونية</h1>
                <div class="header-buttons">
                    <button class="media-management-btn" onclick="openMediaManagement()">إدارة الوسائل</button>
                    <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
                </div>
            </div>

            <div class="web-monitor-content">
                <div class="monitor-main-card">
                    <h2 class="card-title">رصد المواقع الإلكترونية</h2>
                    <p class="card-description">رصد ومتابعة الأخبار والمقالات على المواقع الإلكترونية</p>
                    <button class="start-monitoring-btn" onclick="openWebModal()">بدء الرصد</button>
                </div>
            </div>
        </div>

        <!-- TV Monitor Dashboard -->
        <div id="tvDashboard" class="dashboard">
            <div class="web-monitor-header">
                <h1 class="main-title">راصد القنوات التلفزيونية</h1>
                <div class="header-buttons">
                    <button class="media-management-btn" onclick="openMediaManagement()">إدارة الوسائل</button>
                    <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
                </div>
            </div>

            <div class="web-monitor-content">
                <div class="monitor-main-card">
                    <h2 class="card-title">رصد القنوات التلفزيونية</h2>
                    <p class="card-description">رصد ومتابعة البرامج والأخبار التلفزيونية</p>
                    <button class="start-monitoring-btn" onclick="openTVModal()">بدء الرصد</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Social Media Monitoring Modal -->
    <div id="socialModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('socialModal')">&times;</span>
            <h2>رصد الشبكات الاجتماعية</h2>
            <form onsubmit="submitSocialMonitoring(event)">
                <div class="form-group">
                    <label>التاريخ:</label>
                    <input type="date" id="socialDate" required>
                </div>
                <div class="form-group">
                    <label>المنصة:</label>
                    <select id="socialPlatform" required>
                        <option value="">اختر المنصة</option>
                        <option value="تويتر">تويتر</option>
                        <option value="فيسبوك">فيسبوك</option>
                        <option value="إنستغرام">إنستغرام</option>
                        <option value="يوتيوب">يوتيوب</option>
                        <option value="تيك توك">تيك توك</option>
                        <option value="لينكد إن">لينكد إن</option>
                        <option value="سناب شات">سناب شات</option>
                        <option value="تيليجرام">تيليجرام</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>اسم الحساب:</label>
                    <input type="text" id="socialAccountName" placeholder="أدخل اسم الحساب أو الصفحة" required>
                </div>
                <div class="form-group">
                    <label>الكيان:</label>
                    <select id="socialEntity" onchange="updateSocialEntityInput()">
                        <option value="">اختر الكيان</option>
                        <option value="الحكومة">الحكومة</option>
                        <option value="الحوثي">الحوثي</option>
                        <option value="الإصلاح">الإصلاح</option>
                        <option value="الانتقالي">الانتقالي</option>
                        <option value="مؤتمر صنعاء">مؤتمر صنعاء</option>
                        <option value="مؤتمر الساحل">مؤتمر الساحل</option>
                        <option value="الناصري">الناصري</option>
                        <option value="البعث">البعث</option>
                        <option value="الاشتراكي">الاشتراكي</option>
                        <option value="حلف حضرموت">حلف حضرموت</option>
                        <option value="الإمارات">الإمارات</option>
                        <option value="السعودية">السعودية</option>
                        <option value="التحالف">التحالف</option>
                        <option value="كيان آخر">كيان آخر</option>
                    </select>
                    <input type="text" id="socialEntityInput" placeholder="أو أدخل كيان جديد" onchange="addNewEntity('social')" style="margin-top: 10px;">
                </div>
                <div class="form-group">
                    <label>الملف:</label>
                    <select id="socialFile">
                        <option value="">اختر الملف</option>
                        <!-- سيتم تحديث هذه القائمة ديناميكياً من الملفات المضافة في إدارة الوسائل -->
                    </select>
                </div>
                <div class="form-group">
                    <label>القضية:</label>
                    <select id="socialIssue">
                        <option value="" key="0">اختر القضية</option>
                        <!-- سيتم تحديث هذه القائمة ديناميكياً من القضايا المضافة في إدارة الوسائل -->
                    </select>
                </div>
                <div class="form-group">
                    <label>المسار:</label>
                    <select id="socialPath">
                        <option value="">اختر المسار</option>
                        <option value="السياسي">السياسي</option>
                        <option value="الاجتماعي">الاجتماعي</option>
                        <option value="الثقافي">الثقافي</option>
                        <option value="الدعائي">الدعائي</option>
                        <option value="الدولي">الدولي</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>المستوى:</label>
                    <select id="socialLevel">
                        <option value="">اختر المستوى</option>
                        <option value="عالي">عالي</option>
                        <option value="متوسط">متوسط</option>
                        <option value="منخفض">منخفض</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>نوع المادة:</label>
                    <select id="socialMaterialType">
                        <option value="">اختر نوع المادة</option>
                        <option value="نص">نص</option>
                        <option value="صورة">صورة</option>
                        <option value="فيديو">فيديو</option>
                        <option value="رابط">رابط</option>
                        <option value="استطلاع">استطلاع</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>مستوى النشر:</label>
                    <select id="socialPublishLevel">
                        <option value="">اختر مستوى النشر</option>
                        <!-- سيتم تحديث هذه القائمة ديناميكياً من مستويات النشر المضافة في إدارة الوسائل -->
                    </select>
                </div>
                <div class="form-group">
                    <label>المحتوى/المنشور:</label>
                    <textarea id="socialContent" required placeholder="أدخل المحتوى المرصود هنا..."></textarea>
                </div>
                <div class="form-group">
                    <label>رابط المنشور:</label>
                    <input type="url" id="socialLink" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="socialDailySummary">
                        إضافة للخلاصة اليومية
                    </label>
                </div>
                <button type="submit" class="submit-btn">حفظ البيانات</button>
            </form>
        </div>
    </div>

    <!-- Web Monitoring Modal -->
    <div id="webModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('webModal')">&times;</span>
            <h2>رصد المواقع الإلكترونية</h2>
            <form onsubmit="submitWebMonitoring(event)">
                <div class="form-group">
                    <label>التاريخ:</label>
                    <input type="date" id="webDate" required>
                </div>
                <div class="form-group">
                    <label>الموقع:</label>
                    <div class="custom-select-container">
                        <div class="custom-select" onclick="toggleCustomSelect(this)">
                            <span class="selected-option">اختر الموقع</span>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        <div class="custom-options" id="websiteCustomOptions">
                            <!-- سيتم تحديث هذه القائمة ديناميكياً من JavaScript -->
                        </div>
                    </div>
                    <input type="hidden" id="webSite" name="webSite" required>
                </div>
                <div class="form-group">
                    <label>الكيان التابع للموقع:</label>
                    <input type="text" id="webEntityInput" readonly>
                </div>
                <div class="form-group">
                    <label>الملف:</label>
                    <select id="webFile">
                        <option value="">اختر الملف</option>
                        <!-- سيتم تحديث هذه القائمة ديناميكياً من الملفات المضافة في إدارة الوسائل -->
                    </select>
                </div>
                <div class="form-group">
                    <label>القضية:</label>
                    <select id="webIssue">
                        <option value="">اختر القضية</option>
                        <option value="الأمن والاستقرار">الأمن والاستقرار</option>
                        <option value="الاقتصاد والتنمية">الاقتصاد والتنمية</option>
                        <option value="التعليم والثقافة">التعليم والثقافة</option>
                        <option value="الصحة والخدمات">الصحة والخدمات</option>
                        <option value="حقوق الإنسان">حقوق الإنسان</option>
                        <option value="الشؤون الدولية">الشؤون الدولية</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>المسار:</label>
                    <select id="webPath">
                        <option value="">اختر المسار</option>
                        <option value="السياسي">السياسي</option>
                        <option value="الاجتماعي">الاجتماعي</option>
                        <option value="الثقافي">الثقافي</option>
                        <option value="الدعائي">الدعائي</option>
                        <option value="الدولي">الدولي</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>المستوى:</label>
                    <select id="webLevel">
                        <option value="">اختر المستوى</option>
                        <option value="عالي">عالي</option>
                        <option value="متوسط">متوسط</option>
                        <option value="منخفض">منخفض</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>نوع المادة:</label>
                    <select id="webMaterialType">
                        <option value="">اختر نوع المادة</option>
                        <option value="خبر">خبر</option>
                        <option value="مقال">مقال</option>
                        <option value="تقرير">تقرير</option>
                        <option value="تحليل">تحليل</option>
                        <option value="رأي">رأي</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>مستوى النشر:</label>
                    <select id="webPublishLevel">
                        <option value="">اختر مستوى النشر</option>
                        <!-- سيتم تحديث هذه القائمة ديناميكياً من مستويات النشر المضافة في إدارة الوسائل -->
                    </select>
                </div>
                <div class="form-group">
                    <label>عنوان المقال/الخبر:</label>
                    <input type="text" id="webTitle" required placeholder="أدخل العنوان...">
                </div>
                <div class="form-group">
                    <label>ملخص المحتوى:</label>
                    <textarea id="webContent" required placeholder="أدخل ملخص المحتوى هنا..."></textarea>
                </div>
                <div class="form-group">
                    <label>رابط المقال:</label>
                    <input type="url" id="webLink" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="webDailySummary">
                        إضافة للخلاصة اليومية
                    </label>
                </div>
                <button type="submit" class="submit-btn">حفظ البيانات</button>
            </form>
        </div>
    </div>

    <!-- TV Monitoring Modal -->
    <div id="tvModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('tvModal')">&times;</span>
            <h2>رصد القنوات التلفزيونية</h2>
            <form onsubmit="submitTVMonitoring(event)">
                <div class="form-group">
                    <label>التاريخ:</label>
                    <input type="date" id="tvDate">
                </div>
                <div class="form-group">
                    <label>القناة:</label>
                    <div class="custom-select-container">
                        <div class="custom-select" onclick="toggleCustomSelect(this)">
                            <span class="selected-option">اختر القناة</span>
                            <span class="arrow">▼</span>
                        </div>
                        <div class="custom-options" id="tvChannelOptions">
                            <!-- سيتم ملء القنوات ديناميكياً من localStorage -->
                        </div>
                        <input type="hidden" id="tvChannel" name="tvChannel">
                    </div>
                </div>
                <div class="form-group">
                    <label>الكيان التابع للقناة:</label>
                    <input type="text" id="tvEntityInput" readonly>
                </div>
                <div class="form-group">
                    <label>الملف:</label>
                    <select id="tvFile">
                        <option value="">اختر الملف</option>
                        <!-- سيتم تحديث هذه القائمة ديناميكياً من الملفات المضافة في إدارة الوسائل -->
                    </select>
                </div>
                <div class="form-group">
                    <label>القضية:</label>
                    <select id="tvIssue">
                        <option value="" key="0">اختر القضية</option>
                        <!-- سيتم تحديث هذه القائمة ديناميكياً من القضايا المضافة في إدارة الوسائل -->
                    </select>
                </div>
                <div class="form-group">
                    <label>المسار:</label>
                    <select id="tvPath">
                        <option value="">اختر المسار</option>
                        <option value="السياسي">السياسي</option>
                        <option value="الاجتماعي">الاجتماعي</option>
                        <option value="الثقافي">الثقافي</option>
                        <option value="الدعائي">الدعائي</option>
                        <option value="الدولي">الدولي</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>المستوى:</label>
                    <select id="tvLevel">
                        <option value="">اختر المستوى</option>
                        <option value="عالي">عالي</option>
                        <option value="متوسط">متوسط</option>
                        <option value="منخفض">منخفض</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>نوع البرنامج:</label>
                    <select id="tvProgramType">
                        <option value="">اختر نوع البرنامج</option>
                        <option value="نشرة أخبار">نشرة أخبار</option>
                        <option value="برنامج حواري">برنامج حواري</option>
                        <option value="تقرير إخباري">تقرير إخباري</option>
                        <option value="وثائقي">وثائقي</option>
                        <option value="مقابلة">مقابلة</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>اسم البرنامج:</label>
                    <input type="text" id="tvProgramName" required placeholder="أدخل اسم البرنامج...">
                </div>
                <div class="form-group">
                    <label>وقت البث:</label>
                    <input type="time" id="tvTime">
                </div>
                <div class="form-group">
                    <label>مستوى النشر:</label>
                    <select id="tvPublishLevel">
                        <option value="">اختر مستوى النشر</option>
                        <!-- سيتم تحديث هذه القائمة ديناميكياً من مستويات النشر المضافة في إدارة الوسائل -->
                    </select>
                </div>
                <div class="form-group">
                    <label>ملخص المحتوى:</label>
                    <textarea id="tvContent" required placeholder="أدخل ملخص المحتوى المرصود هنا..."></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="tvDailySummary">
                        إضافة للخلاصة اليومية
                    </label>
                </div>
                <button type="submit" class="submit-btn">حفظ البيانات</button>
            </form>
        </div>
    </div>

    <!-- Website Management Modal -->
    <div id="websiteManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('websiteManagementModal')">&times;</span>
            <h2>إدارة المواقع الإلكترونية</h2>
            
            <div style="margin-bottom: 30px;">
                <h3>إضافة موقع جديد</h3>
                <div class="form-group">
                    <label>اسم الموقع:</label>
                    <input type="text" id="newWebsiteName" placeholder="مثال: موقع الأهرام">
                </div>
                <div class="form-group">
                    <label>الكيان التابع له:</label>
                    <select id="newWebsiteEntity">
                        <option value="">اختر الكيان</option>
                        <option value="الحكومة">الحكومة</option>
                        <option value="الحوثي">الحوثي</option>
                        <option value="الإصلاح">الإصلاح</option>
                        <option value="الانتقالي">الانتقالي</option>
                        <option value="مؤتمر صنعاء">مؤتمر صنعاء</option>
                        <option value="مؤتمر الساحل">مؤتمر الساحل</option>
                        <option value="الناصري">الناصري</option>
                        <option value="البعث">البعث</option>
                        <option value="الاشتراكي">الاشتراكي</option>
                        <option value="حلف حضرموت">حلف حضرموت</option>
                        <option value="الإمارات">الإمارات</option>
                        <option value="السعودية">السعودية</option>
                        <option value="التحالف">التحالف</option>
                        <option value="الإعلام المستقل">الإعلام المستقل</option>
                        <option value="الإعلام الدولي">الإعلام الدولي</option>
                        <option value="كيان آخر">كيان آخر</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>كيان مخصص (إذا اخترت "كيان آخر"):</label>
                    <input type="text" id="customWebsiteEntity" placeholder="أدخل الكيان المخصص">
                </div>
                <button class="action-btn" onclick="addNewWebsite()">إضافة الموقع</button>
            </div>

            <div>
                <h3>المواقع المحفوظة</h3>
                <div id="savedWebsitesList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Saved websites will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- TV Channel Management Modal -->
    <div id="tvManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('tvManagementModal')">&times;</span>
            <h2>إدارة القنوات التلفزيونية</h2>
            
            <div style="margin-bottom: 30px;">
                <h3>إضافة قناة جديدة</h3>
                <div class="form-group">
                    <label>اسم القناة:</label>
                    <input type="text" id="newChannelName" placeholder="مثال: قناة النيل">
                </div>
                <div class="form-group">
                    <label>الكيان التابع لها:</label>
                    <select id="newChannelEntity">
                        <option value="">اختر الكيان</option>
                        <option value="الحكومة">الحكومة</option>
                        <option value="الحوثي">الحوثي</option>
                        <option value="الإصلاح">الإصلاح</option>
                        <option value="الانتقالي">الانتقالي</option>
                        <option value="مؤتمر صنعاء">مؤتمر صنعاء</option>
                        <option value="مؤتمر الساحل">مؤتمر الساحل</option>
                        <option value="الناصري">الناصري</option>
                        <option value="البعث">البعث</option>
                        <option value="الاشتراكي">الاشتراكي</option>
                        <option value="حلف حضرموت">حلف حضرموت</option>
                        <option value="الإمارات">الإمارات</option>
                        <option value="السعودية">السعودية</option>
                        <option value="التحالف">التحالف</option>
                        <option value="الإعلام المستقل">الإعلام المستقل</option>
                        <option value="الإعلام الدولي">الإعلام الدولي</option>
                        <option value="كيان آخر">كيان آخر</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>كيان مخصص (إذا اخترت "كيان آخر"):</label>
                    <input type="text" id="customChannelEntity" placeholder="أدخل الكيان المخصص">
                </div>
                <button class="action-btn" onclick="addNewChannel()">إضافة القناة</button>
            </div>

            <div>
                <h3>القنوات المحفوظة</h3>
                <div id="savedChannelsList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Saved channels will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Consultation Modal -->
    <div id="consultationModal" class="modal">
        <div class="consultation-modal">
            <span class="close" onclick="closeConsultationModal()">&times;</span>
            <h3>طلب استشارة خارجية</h3>
            <p>اختر الدائرة المطلوب استشارتها:</p>
            <div class="department-grid">
                <div class="department-btn" onclick="selectDepartment(this, 'political')">الدائرة السياسية</div>
                <div class="department-btn" onclick="selectDepartment(this, 'organizational')">الدائرة التنظيمية</div>
                <div class="department-btn" onclick="selectDepartment(this, 'guidance')">دائرة التوجيه والإرشاد</div>
                <div class="department-btn" onclick="selectDepartment(this, 'legal')">الدائرة القانونية</div>
                <div class="department-btn" onclick="selectDepartment(this, 'social')">الدائرة الاجتماعية</div>
                <div class="department-btn" onclick="selectDepartment(this, 'students')">دائرة الطلاب</div>
                <div class="department-btn" onclick="selectDepartment(this, 'education')">دائرة التعليم</div>
                <div class="department-btn" onclick="selectDepartment(this, 'unions')">دائرة النقابات</div>
                <div class="department-btn" onclick="selectDepartment(this, 'women')">دائرة المرأة</div>
                <div class="department-btn" onclick="selectDepartment(this, 'foreign_relations')">دائرة العلاقات الخارجية</div>
            </div>
            <div class="form-group">
                <label>تفاصيل الاستشارة:</label>
                <textarea id="consultationDetails" placeholder="أدخل تفاصيل الاستشارة المطلوبة..."></textarea>
            </div>
            <button class="submit-btn" onclick="submitConsultation()">إرسال الاستشارة</button>
        </div>
    </div>

    <!-- Media Management Modal -->
    <div id="mediaManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMediaManagement()">&times;</span>
            <h2>إدارة الوسائل والكيانات</h2>
            
            <div class="media-management-tabs">
                <button class="tab-btn active" onclick="switchTab('websites')">المواقع الإلكترونية</button>
                <button class="tab-btn" onclick="switchTab('channels')">القنوات التلفزيونية</button>
                <button class="tab-btn" onclick="switchTab('files')">إدارة الملفات</button>
                <button class="tab-btn" onclick="switchTab('issues')">إدارة القضايا</button>
                <button class="tab-btn" onclick="switchTab('publishLevels')">مستوى النشر</button>
            </div>

            <!-- Websites Management -->
            <div id="websitesTab" class="tab-content active">
                <h3>إدارة المواقع الإلكترونية</h3>
                
                <div class="add-media-form">
                    <h4>إضافة موقع جديد</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>اسم الموقع:</label>
                            <input type="text" id="newWebsiteName2" placeholder="مثال: موقع إخباري جديد">
                        </div>
                        <div class="form-group">
                            <label>الكيان التابع له:</label>
                            <select id="newWebsiteEntity2">
                                <option value="">اختر الكيان</option>
                                <option value="الحكومة">الحكومة</option>
                                <option value="الحوثي">الحوثي</option>
                                <option value="الإصلاح">الإصلاح</option>
                                <option value="الانتقالي">الانتقالي</option>
                                <option value="مؤتمر صنعاء">مؤتمر صنعاء</option>
                                <option value="مؤتمر الساحل">مؤتمر الساحل</option>
                                <option value="الناصري">الناصري</option>
                                <option value="البعث">البعث</option>
                                <option value="الاشتراكي">الاشتراكي</option>
                                <option value="حلف حضرموت">حلف حضرموت</option>
                                <option value="الإمارات">الإمارات</option>
                                <option value="السعودية">السعودية</option>
                                <option value="التحالف">التحالف</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>مستوى النشر:</label>
                            <select id="newWebsitePublishLevel2">
                                <option value="">اختر مستوى النشر</option>
                                <!-- سيتم تحديث هذه القائمة ديناميكياً من مستويات النشر المضافة -->
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="add-btn" onclick="addNewWebsite2()">إضافة الموقع</button>
                        </div>
                    </div>
                </div>

                <div class="existing-media">
                    <h4>المواقع الموجودة</h4>
                    <div id="websitesList" class="media-list">
                        <!-- Websites will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Channels Management -->
            <div id="channelsTab" class="tab-content">
                <h3>إدارة القنوات التلفزيونية</h3>
                
                <div class="add-media-form">
                    <h4>إضافة قناة جديدة</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>اسم القناة:</label>
                            <input type="text" id="newChannelName2" placeholder="مثال: قناة إخبارية جديدة">
                        </div>
                        <div class="form-group">
                            <label>الكيان التابع لها:</label>
                            <select id="newChannelEntity2">
                                <option value="">اختر الكيان</option>
                                <option value="الحكومة">الحكومة</option>
                                <option value="الحوثي">الحوثي</option>
                                <option value="الإصلاح">الإصلاح</option>
                                <option value="الانتقالي">الانتقالي</option>
                                <option value="مؤتمر صنعاء">مؤتمر صنعاء</option>
                                <option value="مؤتمر الساحل">مؤتمر الساحل</option>
                                <option value="الناصري">الناصري</option>
                                <option value="البعث">البعث</option>
                                <option value="الاشتراكي">الاشتراكي</option>
                                <option value="حلف حضرموت">حلف حضرموت</option>
                                <option value="الإمارات">الإمارات</option>
                                <option value="السعودية">السعودية</option>
                                <option value="التحالف">التحالف</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>مستوى النشر:</label>
                            <select id="newChannelPublishLevel2">
                                <option value="">اختر مستوى النشر</option>
                                <!-- سيتم تحديث هذه القائمة ديناميكياً من مستويات النشر المضافة -->
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="add-btn" onclick="addNewChannel2()">إضافة القناة</button>
                        </div>
                    </div>
                </div>

                <div class="existing-media">
                    <h4>القنوات الموجودة</h4>
                    <div id="channelsList" class="media-list">
                        <!-- Channels will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Files Management -->
            <div id="filesTab" class="tab-content">
                <h3>إدارة الملفات</h3>
                
                <div class="add-media-form">
                    <h4>إضافة ملف جديد</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>اسم الملف:</label>
                            <input type="text" id="newFileName" placeholder="مثال: ملف جديد">
                        </div>
                        <div class="form-group">
                            <button type="button" class="add-btn" onclick="addNewFile()">إضافة الملف</button>
                        </div>
                    </div>
                </div>

                <div class="existing-media">
                    <h4>الملفات الموجودة</h4>
                    <div id="filesList" class="media-list">
                        <!-- Files will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Issues Management -->
            <div id="issuesTab" class="tab-content">
                <h3>إدارة القضايا</h3>
                
                <div class="add-media-form">
                    <h4>إضافة قضية جديدة</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>اسم القضية:</label>
                            <input type="text" id="newIssueName" placeholder="مثال: الانتخابات">
                        </div>
                        <div class="form-group">
                            <button type="button" class="add-btn" onclick="addNewIssue()">إضافة القضية</button>
                        </div>
                    </div>
                </div>

                <div class="existing-media">
                    <h4>القضايا الموجودة</h4>
                    <div id="issuesList" class="media-list">
                        <!-- Issues will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Publish Levels Management -->
            <div id="publishLevelsTab" class="tab-content">
                <h3>إدارة مستوى النشر</h3>
                
                <div class="add-media-form">
                    <h4>إضافة مستوى نشر جديد</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>اسم مستوى النشر:</label>
                            <input type="text" id="newPublishLevelName" placeholder="مثال: محلي، إقليمي، وطني، دولي">
                        </div>
                        <div class="form-group">
                            <button type="button" class="add-btn" onclick="addNewPublishLevel()">إضافة مستوى النشر</button>
                        </div>
                    </div>
                </div>

                <div class="existing-media">
                    <h4>مستويات النشر الموجودة</h4>
                    <div id="publishLevelsList" class="media-list">
                        <!-- Publish levels will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // User data and permissions
        const users = {
            'director': {
                password: '123',
                role: 'director',
                name: 'قيادة الدائرة',
                dashboard: 'directorDashboard',
                modules: ['social', 'web', 'tv', 'analysis', 'production', 'publishing', 'political', 'directives', 'consultations']
            },
            'social': {
                password: '123',
                role: 'social_monitor',
                name: 'راصد الشبكات الاجتماعية',
                dashboard: 'socialDashboard',
                modules: ['social']
            },
            'web': {
                password: '123',
                role: 'web_monitor',
                name: 'راصد المواقع الإلكترونية',
                dashboard: 'webDashboard',
                modules: ['web']
            },
            'tv': {
                password: '123',
                role: 'tv_monitor',
                name: 'راصد القنوات التلفزيونية',
                dashboard: 'tvDashboard',
                modules: ['tv']
            },
            'analyst': {
                password: '123',
                role: 'analyst',
                name: 'المحلل',
                dashboard: 'analystDashboard',
                modules: ['analysis']
            },
            // مسؤولو المسارات الخمسة
            'political_path': {
                password: '123',
                role: 'path_manager',
                name: 'مسؤول المسار السياسي',
                dashboard: 'pathManagerDashboard',
                path: 'السياسي',
                modules: ['path_management']
            },
            'cultural_path': {
                password: '123',
                role: 'path_manager',
                name: 'مسؤول المسار الثقافي',
                dashboard: 'pathManagerDashboard',
                path: 'الثقافي',
                modules: ['path_management']
            },
            'social_path': {
                password: '123',
                role: 'path_manager',
                name: 'مسؤول المسار الاجتماعي',
                dashboard: 'pathManagerDashboard',
                path: 'الاجتماعي',
                modules: ['path_management']
            },
            'propaganda_path': {
                password: '123',
                role: 'path_manager',
                name: 'مسؤول المسار الدعائي',
                dashboard: 'pathManagerDashboard',
                path: 'الدعائي',
                modules: ['path_management']
            },
            'international_path': {
                password: '123',
                role: 'path_manager',
                name: 'مسؤول المسار الدولي',
                dashboard: 'pathManagerDashboard',
                path: 'الدولي',
                modules: ['path_management']
            },
            // المستخدمون القدامى للتوافق
            'admin': {
                password: 'admin123',
                role: 'director',
                name: 'قيادة الدائرة',
                dashboard: 'directorDashboard',
                modules: ['social', 'web', 'tv', 'analysis', 'production', 'publishing', 'political', 'directives', 'consultations']
            },
            'socialmonitor': {
                password: 'social123',
                role: 'social_monitor',
                name: 'راصد الشبكات الاجتماعية',
                dashboard: 'socialDashboard',
                modules: ['social']
            },
            'webmonitor': {
                password: 'web123',
                role: 'web_monitor',
                name: 'راصد المواقع الإلكترونية',
                dashboard: 'webDashboard',
                modules: ['web']
            },
            'tvmonitor': {
                password: 'tv123',
                role: 'tv_monitor',
                name: 'راصد القنوات التلفزيونية',
                dashboard: 'tvDashboard',
                modules: ['tv']
            },
            'analyst': {
                password: 'analyst123',
                role: 'analyst',
                name: 'المحلل',
                dashboard: 'analystDashboard',
                modules: ['analysis']
            },
            'social_monitor1': {
                password: '123456',
                role: 'social_monitor',
                name: 'راصد الشبكات الاجتماعية',
                dashboard: 'socialDashboard',
                modules: ['social']
            },
            'web_monitor1': {
                password: '123456',
                role: 'web_monitor',
                name: 'راصد المواقع الإلكترونية',
                dashboard: 'webDashboard',
                modules: ['web']
            },
            'tv_monitor1': {
                password: '123456',
                role: 'tv_monitor',
                name: 'راصد القنوات التلفزيونية',
                dashboard: 'tvDashboard',
                modules: ['tv']
            },
            'analyst1': {
                password: '123456',
                role: 'analyst',
                name: 'المحلل',
                dashboard: 'analystDashboard',
                modules: ['analysis']
            }
        };

        // Website entities mapping - can be updated by monitors
        let websiteEntities = {
            'الجزيرة نت': 'الإعلام المستقل',
            'العربية نت': 'السعودية',
            'بي بي سي عربي': 'الإعلام الدولي',
            'سكاي نيوز عربية': 'الإمارات',
            'فرانس 24': 'الإعلام الدولي',
            'الشرق الأوسط': 'السعودية',
            // المواقع الإخبارية اليمنية
            'سبأ نت': 'الحكومة',
            'وكالة سبأ للأنباء': 'الحكومة',
            'المسيرة نت': 'الحوثي',
            'الثورة نت': 'الحوثي',
            'المسيرة': 'الحوثي',
            'عدن تايم': 'الانتقالي',
            'عدن الغد': 'الانتقالي',
            'الأيام نت': 'الإعلام المستقل اليمني',
            'نشوان نيوز': 'الإعلام المستقل اليمني',
            'الموقع بوست': 'الإعلام المستقل اليمني',
            'يمن شباب نت': 'الإعلام المستقل اليمني',
            'الخبر اليمني': 'الإعلام المستقل اليمني',
            'يمن برس': 'الإعلام المستقل اليمني',
            'الحدث اليمني': 'الإعلام المستقل اليمني',
            'صحيفة الثورة': 'الحوثي',
            'صحيفة 14 أكتوبر': 'الحكومة',
            'صحيفة الجمهورية': 'الحكومة',
            'خبر عاجل': 'الإعلام المستقل اليمني',
            'يمن فويس': 'الإعلام المستقل اليمني',
            'الصحوة نت': 'الإصلاح',
            'برق نت': 'الإعلام المستقل اليمني',
            'الشارع اليمني': 'الإعلام المستقل اليمني',
            'يمن مونيتور': 'الإعلام المستقل اليمني',
            'الوطن اليمني': 'الإعلام المستقل اليمني'
        };

        // TV entities mapping - can be updated by monitors
        let tvEntities = {
            'الجزيرة': 'الإعلام المستقل',
            'العربية': 'السعودية',
            'بي بي سي عربي': 'الإعلام الدولي',
            'سكاي نيوز عربية': 'الإمارات',
            'فرانس 24': 'الإعلام الدولي',
            'الحدث': 'السعودية',
            // القنوات التلفزيونية اليمنية
            'اليمن اليوم': 'الحكومة',
            'قناة اليمن': 'الحكومة',
            'سهيل': 'الحكومة',
            'المسيرة': 'الحوثي',
            'الحوثي': 'الحوثي',
            'يمن شباب': 'الحوثي',
            'عدن': 'الانتقالي',
            'الغد المشرق': 'الانتقالي',
            'بلقيس': 'الإعلام المستقل اليمني',
            'السعيدة': 'الإعلام المستقل اليمني',
            'الإيمان': 'الإصلاح',
            'شبا': 'الإعلام المستقل اليمني',
            'الأمل': 'الإعلام المستقل اليمني'
        };

        // Social media entities mapping - can be updated by monitors
        let socialEntities = {
            'تويتر': {},
            'فيسبوك': {},
            'إنستغرام': {},
            'يوتيوب': {},
            'تيك توك': {},
            'لينكد إن': {},
            'سناب شات': {},
            'تيليجرام': {}
        };

        // Sample monitoring data for analyst
        // مصفوفة البيانات المرصودة - تتحدث ديناميكياً
        let monitoringData = JSON.parse(localStorage.getItem('monitoringData') || '[]');
        
        // إذا كانت المصفوفة فارغة، أضف بعض البيانات التجريبية
        if (monitoringData.length === 0) {
        // لا توجد بيانات افتراضية - سيتم عرض البيانات الحقيقية من الرصد فقط
        // إذا لم توجد بيانات مُدخلة من الراصدين، ستظهر الصفحة فارغة
        }
        // Sample notifications data
        const notifications = [
            {
                id: 1,
                source: 'المحلل الأول',
                type: 'directive',
                priority: 'urgent',
                time: 'منذ 5 دقائق',
                content: 'موجهة جديدة تتطلب موافقة عاجلة بخصوص التغطية الإعلامية للأحداث الجارية',
                actions: ['approve', 'reject', 'consult', 'viewAnalysis']
            },
            {
                id: 2,
                source: 'الدائرة السياسية',
                type: 'consultation_response',
                priority: 'medium',
                time: 'منذ 15 دقيقة',
                content: 'رد على الاستشارة المرسلة بخصوص الموقف السياسي من القضية المطروحة',
                actions: ['view']
            },
            {
                id: 3,
                source: 'مسؤول المسار الاجتماعي',
                type: 'report',
                priority: 'normal',
                time: 'منذ 30 دقيقة',
                content: 'تقرير يومي عن تنفيذ التكاليف المحولة للمسار الاجتماعي',
                actions: ['view']
            },
            {
                id: 4,
                source: 'راصد الشبكات الاجتماعية',
                type: 'monitoring',
                priority: 'medium',
                time: 'منذ ساعة',
                content: 'رصد محتوى مهم يتطلب تحليل عاجل على منصات التواصل الاجتماعي',
                actions: ['assign']
            },
            {
                id: 5,
                source: 'شعبة الإنتاج',
                type: 'production',
                priority: 'normal',
                time: 'منذ ساعتين',
                content: 'اكتمال إنتاج المواد الإعلامية المطلوبة وجاهزيتها للنشر',
                actions: ['approve', 'review']
            }
        ];

        let selectedDepartment = null;
        let currentDirectiveId = null;

        // Login function
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (users[username] && users[username].password === password) {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById(users[username].dashboard).classList.add('active');
                
                // Update user name in dashboard
                const nameElement = document.getElementById(users[username].role === 'director' ? 'directorName' : 
                                                         users[username].role === 'analyst' ? 'analystName' :
                                                         users[username].role === 'social_monitor' ? 'socialName' :
                                                         users[username].role === 'web_monitor' ? 'webName' : 
                                                         users[username].role === 'tv_monitor' ? 'tvName' :
                                                         users[username].role === 'path_manager' ? 'pathManagerName' : 'userName');
                if (nameElement) {
                    nameElement.textContent = users[username].name;
                }
                
                // Load specific data based on user role
                if (username === 'admin' || username === 'director') {
                    loadNotifications();
                } else if (username === 'analyst1' || username === 'analyst') {
                    loadMonitoringData();
                } else if (users[username].role === 'path_manager') {
                    loadPathDirectives(users[username].path);
                    updateAssignmentPublishLevelOptions();
                }
                
                showNotification(`مرحباً ${users[username].name}`);
            } else {
                showNotification('اسم المستخدم أو كلمة المرور غير صحيحة');
            }
        }

        // Load notifications for director
        function loadNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            const counter = document.getElementById('notificationCounter');
            
            // قراءة الإشعارات المحفوظة من localStorage (التحليلات المرسلة)
            const savedNotifications = JSON.parse(localStorage.getItem('directorNotifications') || '[]');
            
            // قراءة التكاليف من مسؤولي المسارات
            const directorInbox = JSON.parse(localStorage.getItem('directorInbox') || '[]');
            
            // دمج الإشعارات الثابتة مع المحفوظة والتكاليف
            const allNotifications = [...savedNotifications, ...directorInbox, ...notifications.filter(n => n.source !== 'المحلل الأول')];
            
            // ترتيب الإشعارات حسب الوقت (الأحدث أولاً)
            allNotifications.sort((a, b) => {
                const timeA = a.timestamp ? new Date(a.timestamp) : new Date();
                const timeB = b.timestamp ? new Date(b.timestamp) : new Date();
                return timeB - timeA;
            });
            
            if (counter) {
                counter.textContent = allNotifications.length;
            }
            
            if (notificationsList) {
                notificationsList.innerHTML = allNotifications.map(notification => {
                    // إذا كان التكليف من مسؤول مسار
                    if (notification.type === 'assignment') {
                        return `
                            <div class="notification-item priority-normal">
                                <div class="notification-header">
                                    <span class="notification-title">${notification.title}</span>
                                    <span class="notification-time">${new Date(notification.timestamp).toLocaleString('ar-SA')}</span>
                                    <span class="assignment-badge" style="background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 12px; font-size: 12px;">تكليف</span>
                                </div>
                                <div class="notification-text">${notification.content}</div>
                                <div class="assignment-details" style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 14px;">
                                    <div><strong>الجهة المنفذة:</strong> ${notification.details.executingEntity}</div>
                                    <div><strong>زمن التنفيذ:</strong> ${new Date(notification.details.executionTime).toLocaleString('ar-SA')}</div>
                                    <div><strong>مستوى النشر:</strong> ${notification.details.publishLevel}</div>
                                    <div><strong>نوع الوسيلة:</strong> ${notification.details.mediaType}</div>
                                    <div><strong>الوسيلة:</strong> ${notification.details.specificMedia}</div>
                                    <div><strong>المسار:</strong> ${notification.details.path}</div>
                                </div>
                                <div class="notification-actions">
                                    <button class="action-btn approve" onclick="approveAssignment('${notification.id}', this)">إقرار التكليف</button>
                                    <button class="action-btn reject" onclick="rejectAssignment('${notification.id}', this)">رفض التكليف</button>
                                    <button class="action-btn consult" onclick="requestAssignmentModification('${notification.id}', this)">طلب تعديل</button>
                                </div>
                            </div>
                        `;
                    } else {
                        // الإشعارات العادية
                        return `
                            <div class="notification-item priority-${notification.priority === 'urgent' ? 'high' : notification.priority === 'normal' ? 'normal' : 'medium'}">
                                <div class="notification-header">
                                    <span class="notification-title">${notification.source}</span>
                                    <span class="notification-time">${notification.time}</span>
                                </div>
                                <div class="notification-text">${notification.content}</div>
                                <div class="notification-actions">
                                    ${notification.actions.includes('approve') ? `<button class="action-btn approve" onclick="approveDirective(${notification.id}, this)">موافقة</button>` : ''}
                                    ${notification.actions.includes('reject') ? `<button class="action-btn reject" onclick="rejectDirective(${notification.id}, this)">رفض</button>` : ''}
                                    ${notification.actions.includes('consult') ? `<button class="action-btn consult" onclick="requestConsultation(${notification.id}, this)">استشارة خارجية</button>` : ''}
                    ${notification.actions.includes('view') ? `<button class="action-btn approve" onclick="viewItem(${notification.id}, this)">عرض</button>` : ''}
                    ${notification.actions.includes('assign') ? `<button class="action-btn consult" onclick="assignAnalyst(${notification.id}, this)">تكليف محلل</button>` : ''}
                    ${notification.actions.includes('review') ? `<button class="action-btn review" onclick="reviewProduction(${notification.id}, this)">تحقيق وتحليل</button>` : ''}
                    ${notification.actions.includes('viewAnalysis') ? `<button class="action-btn" onclick="viewAnalysisDetails(${notification.id}, this)" style="background: #667eea;">عرض التحليل</button>` : ''}
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }
        }

        // Load monitoring data for analyst
        function loadMonitoringData(sortBy = 'type', groupBy = 'type') {
            const monitoringDataElement = document.getElementById('monitoringData');
            
            // قراءة البيانات من localStorage
            const currentData = JSON.parse(localStorage.getItem('monitoringData') || '[]');
            
            // إضافة واجهة تحكم في الترتيب والتجميع
            let controlsHtml = `
                <div class="monitoring-controls" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e9ecef;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">🔧 خيارات الترتيب والتجميع</h4>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: bold; color: #495057;">ترتيب حسب:</label>
                            <select id="sortBySelect" onchange="updateMonitoringView()" style="padding: 5px 10px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="type" ${sortBy === 'type' ? 'selected' : ''}>نوع الرصد</option>
                                <option value="entity" ${sortBy === 'entity' ? 'selected' : ''}>الكيان</option>
                                <option value="date" ${sortBy === 'date' ? 'selected' : ''}>التاريخ</option>
                                <option value="priority" ${sortBy === 'priority' ? 'selected' : ''}>الأولوية</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: bold; color: #495057;">تجميع حسب:</label>
                            <select id="groupBySelect" onchange="updateMonitoringView()" style="padding: 5px 10px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="type" ${groupBy === 'type' ? 'selected' : ''}>نوع الرصد</option>
                                <option value="entity" ${groupBy === 'entity' ? 'selected' : ''}>الكيان</option>
                                <option value="date" ${groupBy === 'date' ? 'selected' : ''}>التاريخ</option>
                                <option value="none" ${groupBy === 'none' ? 'selected' : ''}>بدون تجميع</option>
                            </select>
                        </div>
                        <button onclick="resetMonitoringView()" style="padding: 5px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            🔄 إعادة تعيين
                        </button>
                    </div>
                </div>
            `;
            
            // تحديد نوع الرصد لكل عنصر
            currentData.forEach(item => {
                if (['تويتر', 'فيسبوك', 'إنستغرام', 'يوتيوب', 'تيك توك', 'سناب شات', 'تيليجرام'].includes(item.source)) {
                    item.monitoringType = 'شبكات التواصل الاجتماعي';
                } else if (['الجزيرة نت', 'العربية نت', 'بي بي سي عربي', 'سي إن إن عربي', 'الشرق الأوسط', 'الإصلاح نت', 'الصحوة نت', 'عدن الغد', 'المشهد اليمني', 'نشوان نيوز', 'الموقع بوست', 'خبر عاجل', 'يمن شباب نت'].includes(item.source)) {
                    item.monitoringType = 'المواقع الإلكترونية';
                } else {
                    item.monitoringType = 'القنوات التلفزيونية';
                }
            });
            
            // ترتيب البيانات حسب الخيار المحدد
            let sortedData = [...currentData];
            switch(sortBy) {
                case 'type':
                    sortedData.sort((a, b) => a.monitoringType.localeCompare(b.monitoringType));
                    break;
                case 'entity':
                    sortedData.sort((a, b) => (a.entity || '').localeCompare(b.entity || ''));
                    break;
                case 'date':
                    sortedData.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                    break;
                case 'priority':
                    const priorityOrder = { 'عالي': 3, 'متوسط': 2, 'منخفض': 1 };
                    sortedData.sort((a, b) => (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0));
                    break;
            }
            
            // تجميع البيانات حسب الخيار المحدد
            let groupedData = {};
            if (groupBy === 'none') {
                groupedData['جميع البيانات'] = sortedData;
            } else {
                sortedData.forEach(item => {
                    let groupKey;
                    switch(groupBy) {
                        case 'type':
                            groupKey = item.monitoringType;
                            break;
                        case 'entity':
                            groupKey = item.entity || 'غير محدد';
                            break;
                        case 'date':
                            groupKey = item.date || 'غير محدد';
                            break;
                        default:
                            groupKey = item.monitoringType;
                    }
                    
                    if (!groupedData[groupKey]) {
                        groupedData[groupKey] = [];
                    }
                    groupedData[groupKey].push(item);
                });
            }
            
            
            let html = controlsHtml + `<h4>البيانات المرصودة للتحليل (${currentData.length} عنصر)</h4>`;
            
            // عرض البيانات مجمعة حسب الخيار المحدد
            Object.keys(groupedData).forEach(groupKey => {
                if (groupedData[groupKey].length > 0) {
                    const groupIcon = groupBy === 'type' ? '📊' : groupBy === 'entity' ? '🏢' : groupBy === 'date' ? '📅' : '📋';
                    html += `
                        <div class="monitoring-type-section">
                            <h5 class="monitoring-type-header">
                                ${groupIcon} ${groupKey} (${groupedData[groupKey].length} عنصر)
                            </h5>
                            <div class="monitoring-type-content">
                    `;
                    
                    groupedData[groupKey].forEach(item => {
                        html += `
                            <div class="monitoring-item">
                                <div class="monitoring-header">
                                    <span class="monitoring-source">${item.source}</span>
                                    <span class="notification-time">${item.date}</span>
                                    <span class="priority-badge priority-${item.priority === 'عالي' ? 'high' : item.priority === 'متوسط' ? 'medium' : 'low'}">${item.priority}</span>
                                    <span class="monitoring-type-badge" style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 5px;">
                                        ${item.monitoringType}
                                    </span>
                                </div>
                                <div class="monitoring-details">
                                    <div class="detail-row">
                                        <span class="detail-label">الكيان:</span>
                                        <span class="detail-value">${item.entity || 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">الملف:</span>
                                        <span class="detail-value">${item.file}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">الرابط:</span>
                                        <span class="detail-value"><a href="${item.link}" target="_blank" style="color: #667eea;">عرض المصدر</a></span>
                                    </div>
                                </div>
                                <div class="monitoring-content">
                                    "${item.content}"
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 10px;">
                                    <button class="action-btn start-analysis-btn" onclick="startAnalysis('${item.id}')">بدء التحليل</button>
                                    <button class="action-btn" onclick="viewFullContent('${item.id}')" style="background: #3742fa;">عرض المحتوى الكامل</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            if (Object.keys(groupedData).length === 0 || currentData.length === 0) {
                html += `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h5>📭 لا توجد بيانات مرصودة حالياً</h5>
                        <p>سيتم عرض البيانات هنا عند إضافتها من قبل الراصدين</p>
                    </div>
                `;
            }
            
            monitoringDataElement.innerHTML = html;
        }

        // دالة تحديث عرض البيانات المرصودة
        function updateMonitoringView() {
            const sortBy = document.getElementById('sortBySelect').value;
            const groupBy = document.getElementById('groupBySelect').value;
            loadMonitoringData(sortBy, groupBy);
        }

        // دالة إعادة تعيين عرض البيانات المرصودة
        function resetMonitoringView() {
            loadMonitoringData('type', 'type');
        }

        // Start analysis function
        function startAnalysis(itemId) {
            document.getElementById('analysisId').value = itemId;
            showNotification(`بدء تحليل المحتوى ${itemId}`);
        }

        // View full content function
        function viewFullContent(itemId) {
            const item = monitoringData.find(data => data.id === itemId);
            if (item) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                        <h2>المحتوى الكامل - ${item.id}</h2>
                        <div style="margin: 20px 0;">
                            <strong>المصدر:</strong> ${item.source}<br>
                            <strong>الكيان:</strong> ${item.entity}<br>
                            <strong>الملف:</strong> ${item.file}<br>
                            <strong>التاريخ:</strong> ${item.date}<br>
                            <strong>الرابط:</strong> <a href="${item.link}" target="_blank" style="color: #667eea;">${item.link}</a>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; line-height: 1.6;">
                            ${item.fullContent}
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="action-btn" onclick="window.open('${item.link}', '_blank')" style="background: #667eea;">فتح الرابط الأصلي</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        // Directive actions
        function approveDirective(id, buttonElement) {
            // إضافة تأثير بصري للزر
            if (buttonElement) {
                buttonElement.style.transform = 'scale(0.95)';
                buttonElement.style.opacity = '0.7';
                
                setTimeout(() => {
                    buttonElement.style.transform = 'scale(1)';
                    buttonElement.style.opacity = '1';
                }, 150);
            }
            
            // فتح نافذة اختيار المسارات
            showPathSelectionModal(id);
        }

        // دالة عرض نافذة اختيار المسارات
        function showPathSelectionModal(directiveId) {
            // البحث عن الإشعار في localStorage
            const notifications = JSON.parse(localStorage.getItem('directorNotifications') || '[]');
            const notification = notifications.find(n => n.id === directiveId);
            
            if (!notification) {
                showNotification('لم يتم العثور على الموجهة المطلوبة', 'error');
                return;
            }

            // إنشاء نافذة اختيار المسارات
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>📋 إرسال موجه جديد</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        
                        <!-- نص الموجه -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">نص الموجه:</h4>
                            <div style="background: white; padding: 10px; border-radius: 4px; line-height: 1.6;">
                                ${notification.fullContent || notification.content}
                            </div>
                        </div>

                        <!-- المسارات المطلوبة -->
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">المسارات المطلوبة:</h4>
                            <div style="display: grid; gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#e9ecef'">
                                    <input type="checkbox" name="selectedPaths" value="السياسي" style="transform: scale(1.2);">
                                    <span style="font-weight: 500;">المسار السياسي</span>
                                    <span style="margin-right: auto; color: #6c757d; font-size: 14px;">✓</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#e9ecef'">
                                    <input type="checkbox" name="selectedPaths" value="الثقافي" style="transform: scale(1.2);">
                                    <span style="font-weight: 500;">المسار الثقافي</span>
                                    <span style="margin-right: auto; color: #6c757d; font-size: 14px;">✓</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#e9ecef'">
                                    <input type="checkbox" name="selectedPaths" value="الاجتماعي" style="transform: scale(1.2);">
                                    <span style="font-weight: 500;">المسار الاجتماعي</span>
                                    <span style="margin-right: auto; color: #6c757d; font-size: 14px;">✓</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#e9ecef'">
                                    <input type="checkbox" name="selectedPaths" value="الدعائي" style="transform: scale(1.2);">
                                    <span style="font-weight: 500;">المسار الدعائي</span>
                                    <span style="margin-right: auto; color: #6c757d; font-size: 14px;">✓</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#e9ecef'">
                                    <input type="checkbox" name="selectedPaths" value="الدولي" style="transform: scale(1.2);">
                                    <span style="font-weight: 500;">المسار الدولي</span>
                                    <span style="margin-right: auto; color: #6c757d; font-size: 14px;">✓</span>
                                </label>
                            </div>
                        </div>

                        <!-- أزرار الإجراءات -->
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                            <button class="action-btn" onclick="sendToSelectedPaths(${directiveId}); this.closest('.modal').remove();" style="background: #667eea; padding: 12px 24px; font-size: 16px;">إرسال الموجه</button>
                            <button class="action-btn" onclick="this.closest('.modal').remove();" style="background: #6c757d; padding: 12px 24px; font-size: 16px;">إلغاء</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            // إضافة تأثير الظهور
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }

        // دالة إرسال الموجه للمسارات المحددة
        function sendToSelectedPaths(directiveId) {
            const selectedPaths = [];
            const checkboxes = document.querySelectorAll('input[name="selectedPaths"]:checked');
            
            checkboxes.forEach(checkbox => {
                selectedPaths.push(checkbox.value);
            });
            
            if (selectedPaths.length === 0) {
                showNotification('يرجى اختيار مسار واحد على الأقل', 'error');
                return;
            }
            
            // حفظ الموجه في localStorage للمسارات المحددة
            const pathDirectives = JSON.parse(localStorage.getItem('pathDirectives') || '[]');
            const notifications = JSON.parse(localStorage.getItem('directorNotifications') || '[]');
            const notification = notifications.find(n => n.id === directiveId);
            
            selectedPaths.forEach(path => {
                const directive = {
                    id: Date.now() + Math.random(),
                    path: path,
                    content: notification.fullContent || notification.content,
                    recommendations: notification.recommendations || '',
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    originalNotificationId: directiveId
                };
                pathDirectives.push(directive);
            });
            
            localStorage.setItem('pathDirectives', JSON.stringify(pathDirectives));
            
            showNotification(`✅ تم إرسال الموجه إلى ${selectedPaths.length} مسار: ${selectedPaths.join(', ')}`);
            
            // إزالة الإشعار الأصلي
            setTimeout(() => {
                removeNotification(directiveId);
            }, 1000);
        }

        function rejectDirective(id, buttonElement) {
            // إضافة تأثير بصري للزر
            if (buttonElement) {
                buttonElement.style.transform = 'scale(0.95)';
                buttonElement.style.opacity = '0.7';
                
                setTimeout(() => {
                    buttonElement.style.transform = 'scale(1)';
                    buttonElement.style.opacity = '1';
                }, 150);
            }
            
            const reason = prompt('أدخل سبب الرفض:');
            if (reason) {
                showNotification('❌ تم رفض الموجهة وإرسال الملاحظات للمحلل');
                
                // إضافة تأثير اختفاء للإشعار
                setTimeout(() => {
                    removeNotification(id);
                }, 1000);
            }
        }

        function requestConsultation(id, buttonElement) {
            // إضافة تأثير بصري للزر
            if (buttonElement) {
                buttonElement.style.transform = 'scale(0.95)';
                buttonElement.style.opacity = '0.7';
                
                setTimeout(() => {
                    buttonElement.style.transform = 'scale(1)';
                    buttonElement.style.opacity = '1';
                }, 150);
            }
            
            currentDirectiveId = id;
            showNotification('🔍 فتح نافذة الاستشارة الخارجية...');
            
            setTimeout(() => {
                document.getElementById('consultationModal').style.display = 'block';
            }, 500);
        }

        function selectDepartment(element, department) {
            // Remove previous selection
            document.querySelectorAll('.department-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selection to clicked element
            element.classList.add('selected');
            selectedDepartment = department;
        }

        function submitConsultation() {
            if (!selectedDepartment) {
                showNotification('يرجى اختيار الدائرة المطلوب استشارتها');
                return;
            }
            
            const details = document.getElementById('consultationDetails').value;
            if (!details.trim()) {
                showNotification('يرجى إدخال تفاصيل الاستشارة');
                return;
            }
            
            showNotification('تم إرسال الاستشارة للدائرة المختصة');
            closeConsultationModal();
            if (currentDirectiveId) {
                removeNotification(currentDirectiveId);
            }
        }

        function closeConsultationModal() {
            document.getElementById('consultationModal').style.display = 'none';
            selectedDepartment = null;
            currentDirectiveId = null;
            document.getElementById('consultationDetails').value = '';
            document.querySelectorAll('.department-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        function removeNotification(id) {
            const index = notifications.findIndex(n => n.id === id);
            if (index > -1) {
                notifications.splice(index, 1);
                loadNotifications();
            }
        }

        function viewItem(id, buttonElement) {
            // إضافة تأثير بصري للزر
            if (buttonElement) {
                buttonElement.style.transform = 'scale(0.95)';
                buttonElement.style.opacity = '0.7';
                
                setTimeout(() => {
                    buttonElement.style.transform = 'scale(1)';
                    buttonElement.style.opacity = '1';
                }, 150);
            }
            
            showNotification('📋 عرض التفاصيل...');
            
            // إضافة تأثير اختفاء للإشعار
            setTimeout(() => {
                removeNotification(id);
            }, 1000);
        }

        function assignAnalyst(id, buttonElement) {
            // إضافة تأثير بصري للزر
            if (buttonElement) {
                buttonElement.style.transform = 'scale(0.95)';
                buttonElement.style.opacity = '0.7';
                
                setTimeout(() => {
                    buttonElement.style.transform = 'scale(1)';
                    buttonElement.style.opacity = '1';
                }, 150);
            }
            
            showNotification('👨‍💼 تم تكليف المحلل بالمحتوى المرصود');
            
            // إضافة تأثير اختفاء للإشعار
            setTimeout(() => {
                removeNotification(id);
            }, 1000);
        }

        function reviewProduction(id, buttonElement) {
            // إضافة تأثير بصري للزر
            if (buttonElement) {
                buttonElement.style.transform = 'scale(0.95)';
                buttonElement.style.opacity = '0.7';
                
                setTimeout(() => {
                    buttonElement.style.transform = 'scale(1)';
                    buttonElement.style.opacity = '1';
                }, 150);
            }
            
            showNotification('🔍 تم طلب تحقيق وتحليل إضافي للتقرير');
            
            // إضافة تأثير اختفاء للإشعار
            setTimeout(() => {
                removeNotification(id);
            }, 1000);
        }

        // Update website entity automatically
        function updateWebsiteEntity() {
            const websiteSelect = document.getElementById('webSite');
            const entityInput = document.getElementById('webEntityInput');
            
            if (websiteSelect && entityInput) {
                const selectedWebsite = websiteSelect.value;
                console.log('Selected website from hidden input:', selectedWebsite);
                
                // البحث في المواقع المضافة أولاً
                const customWebsites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
                console.log('Custom websites:', customWebsites);
                const customWebsite = customWebsites.find(site => site.name === selectedWebsite);
                
                if (customWebsite) {
                    // إذا كان الموقع من المواقع المضافة، استخدم الكيان المحفوظ معه
                    entityInput.value = customWebsite.entity;
                    entityInput.readOnly = true;
                    console.log('Entity updated from custom websites:', customWebsite.entity);
                } else if (websiteEntities[selectedWebsite]) {
                    // إذا كان الموقع من المواقع الافتراضية، استخدم الكيان المحفوظ
                    entityInput.value = websiteEntities[selectedWebsite];
                    entityInput.readOnly = true;
                    console.log('Entity updated from default websites:', websiteEntities[selectedWebsite]);
                } else if (selectedWebsite === 'موقع آخر') {
                    entityInput.value = '';
                    entityInput.readOnly = false;
                    entityInput.placeholder = 'أدخل الكيان التابع للموقع';
                } else {
                    entityInput.value = '';
                    entityInput.readOnly = true;
                    console.log('No entity found for website:', selectedWebsite);
                }
            }
            
            // تحديث إضافي للقائمة المنسدلة المخصصة
            const customSelect = document.querySelector('.custom-select .selected-option');
            if (customSelect && entityInput) {
                const selectedWebsite = customSelect.textContent.trim();
                console.log('Selected website from custom select:', selectedWebsite);
                
                // البحث في المواقع المضافة
                const customWebsites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
                const customWebsite = customWebsites.find(site => site.name === selectedWebsite);
                
                if (customWebsite) {
                    entityInput.value = customWebsite.entity;
                    entityInput.readOnly = true;
                    console.log('Entity updated from custom select:', customWebsite.entity);
                }
            }
        }

        // Update TV entity automatically
        function updateTVEntityInput() {
            const tvSelect = document.getElementById('tvChannel');
            const entityInput = document.getElementById('tvEntityInput');
            
            if (tvSelect && entityInput) {
                const selectedChannel = tvSelect.value;
                if (tvEntities[selectedChannel]) {
                    entityInput.value = tvEntities[selectedChannel];
                    entityInput.readOnly = true;
                } else if (selectedChannel === 'قناة أخرى') {
                    entityInput.value = '';
                    entityInput.readOnly = false;
                    entityInput.placeholder = 'أدخل الكيان التابع للقناة';
                } else {
                    entityInput.value = '';
                    entityInput.readOnly = true;
                }
            }
        }

        // Update social entity input
        function updateSocialEntityInput() {
            const entitySelect = document.getElementById('socialEntity');
            const entityInput = document.getElementById('socialEntityInput');
            
            if (entitySelect && entityInput) {
                const selectedEntity = entitySelect.value;
                if (selectedEntity && selectedEntity !== 'كيان آخر') {
                    entityInput.value = selectedEntity;
                    entityInput.readOnly = true;
                } else if (selectedEntity === 'كيان آخر') {
                    entityInput.value = '';
                    entityInput.readOnly = false;
                    entityInput.placeholder = 'أدخل كيان جديد';
                } else {
                    entityInput.value = '';
                    entityInput.readOnly = true;
                }
            }
        }

        // Enable entity editing
        function enableEntityEdit(inputId) {
            const entityInput = document.getElementById(inputId);
            if (entityInput) {
                entityInput.readOnly = false;
                entityInput.focus();
                showNotification('يمكنك الآن تعديل الكيان');
            }
        }

        // Add new entity or update existing one
        function addNewEntity(type) {
            const input = document.getElementById(type + 'EntityInput');
            if (input && input.value.trim()) {
                showNotification('تم إضافة الكيان الجديد: ' + input.value);
            }
        }

        // Save entity mapping for websites
        function saveWebsiteEntity() {
            const websiteSelect = document.getElementById('webSite');
            const entityInput = document.getElementById('webEntityInput');
            
            if (websiteSelect && entityInput && websiteSelect.value && entityInput.value.trim()) {
                websiteEntities[websiteSelect.value] = entityInput.value.trim();
                showNotification(`تم ربط ${websiteSelect.value} بالكيان: ${entityInput.value}`);
                saveToLocalStorage();
            }
        }

        // Save entity mapping for TV channels
        function saveTVEntity() {
            const tvSelect = document.getElementById('tvChannel');
            const entityInput = document.getElementById('tvEntityInput');
            
            if (tvSelect && entityInput && tvSelect.value && entityInput.value.trim()) {
                tvEntities[tvSelect.value] = entityInput.value.trim();
                showNotification(`تم ربط ${tvSelect.value} بالكيان: ${entityInput.value}`);
                saveToLocalStorage();
            }
        }

        // Save entity mapping for social media
        function saveSocialEntity() {
            const platformSelect = document.getElementById('socialPlatform');
            const entityInput = document.getElementById('socialEntityInput');
            
            if (platformSelect && entityInput && platformSelect.value && entityInput.value.trim()) {
                if (!socialEntities[platformSelect.value]) {
                    socialEntities[platformSelect.value] = {};
                }
                // For social media, we can have multiple entities per platform
                const accountName = prompt('أدخل اسم الحساب أو الصفحة:');
                if (accountName) {
                    socialEntities[platformSelect.value][accountName] = entityInput.value.trim();
                    showNotification(`تم ربط ${accountName} على ${platformSelect.value} بالكيان: ${entityInput.value}`);
                    saveToLocalStorage();
                }
            }
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('websiteEntities', JSON.stringify(websiteEntities));
                localStorage.setItem('tvEntities', JSON.stringify(tvEntities));
                localStorage.setItem('socialEntities', JSON.stringify(socialEntities));
            } catch (e) {
                console.log('Could not save to localStorage:', e);
            }
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const savedWebsiteEntities = localStorage.getItem('websiteEntities');
                const savedTVEntities = localStorage.getItem('tvEntities');
                const savedSocialEntities = localStorage.getItem('socialEntities');
                
                if (savedWebsiteEntities) {
                    websiteEntities = { ...websiteEntities, ...JSON.parse(savedWebsiteEntities) };
                }
                if (savedTVEntities) {
                    tvEntities = { ...tvEntities, ...JSON.parse(savedTVEntities) };
                }
                if (savedSocialEntities) {
                    socialEntities = { ...socialEntities, ...JSON.parse(savedSocialEntities) };
                }
            } catch (e) {
                console.log('Could not load from localStorage:', e);
            }
        }

        // Modal functions
        function openSocialModal() {
            updateFileOptions(); // تحديث قائمة الملفات
            updateIssueOptions(); // تحديث قائمة القضايا
            document.getElementById('socialModal').style.display = 'block';
        }

        function openWebModal() {
            updateFileOptions(); // تحديث قائمة الملفات
            updateIssueOptions(); // تحديث قائمة القضايا
            updateCustomWebsiteSelect(); // تحديث قائمة المواقع
            document.getElementById('webModal').style.display = 'block';
        }

        function openTVModal() {
            updateFileOptions(); // تحديث قائمة الملفات
            updateIssueOptions(); // تحديث قائمة القضايا
            updateChannelOptions(); // تحديث قائمة القنوات
            document.getElementById('tvModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openModal(modalId) {
            showNotification('هذه الوظيفة قيد التطوير');
        }

        // Submit functions
        function submitSocialMonitoring(event) {
            event.preventDefault();
            
            // Get form data including account name
            const platform = document.getElementById('socialPlatform').value;
            const accountName = document.getElementById('socialAccountName').value;
            const entity = document.getElementById('socialEntity').value || document.getElementById('socialEntityInput').value;
            const file = document.getElementById('socialFile').value;
            const path = document.getElementById('socialPath').value;
            const level = document.getElementById('socialLevel').value;
            const type = document.getElementById('socialMaterialType').value;
            const issue = document.getElementById('socialIssue').value;
            const content = document.getElementById('socialContent').value;
            const link = document.getElementById('socialLink').value;
            const date = document.getElementById('socialDate').value;
            const publishLevel = document.getElementById('socialPublishLevel').value;
            
            // إضافة قيم افتراضية للحقول الفارغة
            const finalFile = (file && !file.includes('اختر')) ? file : 'عام';
            const finalPath = (path && !path.includes('اختر')) ? path : 'سياسي';
            const finalLevel = (level && !level.includes('اختر')) ? level : 'متوسط';
            const finalType = (type && !type.includes('اختر')) ? type : 'نص';
            const finalIssue = (issue && !issue.includes('اختر')) ? issue : 'الأمن والاستقرار';
            
            // Validate required fields
            if (!platform || !accountName || !entity) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            // Save entity mapping if new entity was added
            // تم تعطيل saveSocialEntity لمنع ظهور النافذة المنبثقة غير المرغوب فيها
            // const platformSelect = document.getElementById('socialPlatform');
            // const entityInput = document.getElementById('socialEntityInput');
            // if (platformSelect.value && entityInput.value.trim()) {
            //     saveSocialEntity();
            // }
            
            // إضافة البيانات إلى قائمة البيانات المرصودة للتحليل
            const newMonitoringItem = {
                id: 'MON-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-3),
                source: platform,
                entity: entity,
                file: file || 'عام',
                date: date || new Date().toISOString().split('T')[0],
                priority: level === 'عاجل' ? 'عالي' : level === 'مهم' ? 'متوسط' : 'منخفض',
                content: content || 'محتوى من ' + platform + ' للحساب: ' + accountName,
                link: link || '#',
                fullContent: content || 'المحتوى الكامل: ' + content
            };
            
            // إضافة العنصر إلى مصفوفة البيانات المرصودة
            monitoringData.push(newMonitoringItem);
            
            // حفظ البيانات المحدثة في localStorage
            localStorage.setItem('monitoringData', JSON.stringify(monitoringData));
            
            // إعادة تحميل البيانات إذا كان المحلل مسجل دخول
            if (document.querySelector('.analyst-container') && document.querySelector('.analyst-container').style.display !== 'none') {
                loadMonitoringData();
            }
            
            showNotification('تم حفظ بيانات رصد الشبكات الاجتماعية بنجاح (المنصة: ' + platform + ', الحساب: ' + accountName + ', الكيان: ' + entity + ')');
            
            // إعادة تعيين النموذج
            document.querySelector('#socialModal form').reset();
            closeModal('socialModal');
        }

        function submitWebMonitoring(event) {
            event.preventDefault();
            
            try {
                // Get form data with null checks
                const websiteElement = document.getElementById('webSite');
                const entityElement = document.getElementById('webEntityInput');
                const fileElement = document.getElementById('webFile');
                const contentElement = document.getElementById('webContent');
                const linkElement = document.getElementById('webLink');
                const dateElement = document.getElementById('webDate');
                const levelElement = document.getElementById('webLevel');
                const issueElement = document.getElementById('webIssue');
                const pathElement = document.getElementById('webPath');
                const titleElement = document.getElementById('webTitle');
                const typeElement = document.getElementById('webMaterialType');
                const publishLevelElement = document.getElementById('webPublishLevel');
                
                const website = websiteElement ? websiteElement.value : '';
                const entity = entityElement ? entityElement.value : '';
                const file = fileElement ? fileElement.value : '';
                const content = contentElement ? contentElement.value : '';
                const link = linkElement ? linkElement.value : '';
                const date = dateElement ? dateElement.value : '';
                const level = levelElement ? levelElement.value : '';
                const issue = issueElement ? issueElement.value : '';
                const path = pathElement ? pathElement.value : '';
                const title = titleElement ? titleElement.value : '';
                const type = typeElement ? typeElement.value : 'خبر';
                const publishLevel = publishLevelElement ? publishLevelElement.value : '';
                
                // Validate required fields - تم إصلاح الفحص
                console.log('فحص الحقول المطلوبة...');
                console.log('website:', website);
                console.log('file:', file);
                console.log('path:', path);
                console.log('level:', level);
                console.log('type:', type);
                console.log('title:', title);
                console.log('content:', content);
                
                // فحص الحقول الإجبارية فقط مع قيم افتراضية للحقول الاختيارية
                const isWebsiteValid = website && website.trim() !== '' && !website.includes('اختر');
                const isTitleValid = title && title.trim() !== '';
                const isContentValid = content && content.trim() !== '';
                
                // إضافة قيم افتراضية للحقول الفارغة
                const finalFile = (file && !file.includes('اختر')) ? file : 'عام';
                const finalPath = (path && !path.includes('اختر')) ? path : 'سياسي';
                const finalLevel = (level && !level.includes('اختر')) ? level : 'متوسط';
                const finalType = (type && !type.includes('اختر')) ? type : 'خبر';
                const finalIssue = (issue && !issue.includes('اختر')) ? issue : 'الأمن والاستقرار';
                
                if (!isWebsiteValid || !isTitleValid || !isContentValid) {
                    console.log('فشل في التحقق من الحقول الإجبارية:');
                    console.log('الموقع صالح:', isWebsiteValid);
                    console.log('العنوان صالح:', isTitleValid);
                    console.log('المحتوى صالح:', isContentValid);
                    
                    showNotification('يرجى ملء الحقول الإجبارية: الموقع، العنوان، المحتوى', 'error');
                    return;
                }
                
                console.log('✅ تم التحقق من جميع الحقول بنجاح');
                
                // Save entity mapping if new entity was added
                if (typeof saveWebsiteEntity === 'function') {
                    saveWebsiteEntity();
                }
                
                // إضافة البيانات إلى قائمة البيانات المرصودة للتحليل
                const newMonitoringItem = {
                    id: 'MON-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-3),
                    source: website,
                    entity: entity,
                    file: finalFile,
                    date: date || new Date().toISOString().split('T')[0],
                    priority: finalLevel === 'عالي' ? 'عالي' : finalLevel === 'متوسط' ? 'متوسط' : 'منخفض',
                    content: content || 'محتوى من موقع ' + website,
                    link: link || '#',
                    fullContent: content || 'المحتوى الكامل: ' + content,
                    issue: finalIssue,
                    path: finalPath,
                    type: finalType,
                    title: title
                };
                
                // إضافة العنصر إلى مصفوفة البيانات المرصودة
                if (typeof monitoringData !== 'undefined') {
                    monitoringData.push(newMonitoringItem);
                    
                    // حفظ البيانات المحدثة في localStorage
                    localStorage.setItem('monitoringData', JSON.stringify(monitoringData));
                    
                    // إعادة تحميل البيانات إذا كان المحلل مسجل دخول
                    if (document.querySelector('.analyst-container') && document.querySelector('.analyst-container').style.display !== 'none') {
                        if (typeof loadMonitoringData === 'function') {
                            loadMonitoringData();
                        }
                    }
                }
                
                showNotification('تم حفظ بيانات رصد المواقع الإلكترونية بنجاح (الموقع: ' + website + ', الكيان: ' + entity + ', الملف: ' + finalFile + ')');
                
                // إعادة تعيين النموذج
                const form = document.querySelector('#webModal form');
                if (form) {
                    form.reset();
                }
                closeModal('webModal');
                
            } catch (error) {
                console.error('خطأ في حفظ بيانات رصد المواقع:', error);
                showNotification('حدث خطأ أثناء حفظ البيانات', 'error');
            }
        }

        function submitTVMonitoring(event) {
            event.preventDefault();
            
            // Get form data with null checks
            const channelElement = document.getElementById('tvChannel');
            const entityElement = document.getElementById('tvEntityInput');
            const fileElement = document.getElementById('tvFile');
            const contentElement = document.getElementById('tvContent');
            const dateElement = document.getElementById('tvDate');
            const levelElement = document.getElementById('tvLevel');
            const issueElement = document.getElementById('tvIssue');
            const pathElement = document.getElementById('tvPath');
            const programTypeElement = document.getElementById('tvProgramType');
            const programNameElement = document.getElementById('tvProgramName');
            const timeElement = document.getElementById('tvTime');
            const publishLevelElement = document.getElementById('tvPublishLevel');
            
            const channel = channelElement ? channelElement.value : '';
            const entity = entityElement ? entityElement.value : '';
            const file = fileElement ? fileElement.value : '';
            const content = contentElement ? contentElement.value : '';
            const date = dateElement ? dateElement.value : '';
            const level = levelElement ? levelElement.value : '';
            const issue = issueElement ? issueElement.value : '';
            const path = pathElement ? pathElement.value : '';
            const programType = programTypeElement ? programTypeElement.value : '';
            const programName = programNameElement ? programNameElement.value : '';
            const time = timeElement ? timeElement.value : '';
            const publishLevel = publishLevelElement ? publishLevelElement.value : '';
            
            // إضافة قيم افتراضية للحقول الفارغة
            const finalChannel = (channel && !channel.includes('اختر')) ? channel : 'قناة تجريبية';
            const finalEntity = entity || 'كيان تجريبي';
            const finalFile = (file && !file.includes('اختر')) ? file : 'عام';
            const finalLevel = (level && !level.includes('اختر')) ? level : 'متوسط';
            const finalIssue = (issue && !issue.includes('اختر')) ? issue : 'الأمن';
            const finalPath = (path && !path.includes('اختر')) ? path : 'السياسي';
            const finalProgramType = (programType && !programType.includes('اختر')) ? programType : 'نشرة أخبار';
            const finalProgramName = programName || 'برنامج تجريبي';
            const finalContent = content || 'محتوى تجريبي من ' + finalChannel;
            const finalDate = date || new Date().toISOString().split('T')[0];
            const finalTime = time || '20:00';
            
            // Validate required fields - التحقق من الحقول الأساسية فقط
            if (!finalProgramName.trim() || !finalContent.trim()) {
                showNotification('يرجى ملء اسم البرنامج وملخص المحتوى على الأقل', 'error');
                return;
            }
            
            // Save entity mapping if new entity was added
            // تم تعطيل saveTVEntity لمنع ظهور النافذة المنبثقة غير المرغوب فيها
            // saveTVEntity();
            
            // إضافة البيانات إلى قائمة البيانات المرصودة للتحليل
            const newMonitoringItem = {
                id: 'MON-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-3),
                source: finalChannel,
                entity: finalEntity,
                file: finalFile,
                date: finalDate,
                priority: finalLevel === 'عالي' ? 'عالي' : finalLevel === 'متوسط' ? 'متوسط' : 'منخفض',
                content: finalContent,
                link: '#',
                fullContent: 'البرنامج: ' + finalProgramName + ' - النوع: ' + finalProgramType + ' - الوقت: ' + finalTime + ' - المحتوى: ' + finalContent,
                programName: finalProgramName,
                programType: finalProgramType,
                time: finalTime,
                issue: finalIssue,
                path: finalPath
            };
            
            // إضافة العنصر إلى مصفوفة البيانات المرصودة
            monitoringData.push(newMonitoringItem);
            
            // حفظ البيانات المحدثة في localStorage
            localStorage.setItem('monitoringData', JSON.stringify(monitoringData));
            
            // إعادة تحميل البيانات إذا كان المحلل مسجل دخول
            if (document.querySelector('.analyst-container') && document.querySelector('.analyst-container').style.display !== 'none') {
                loadMonitoringData();
            }
            
            showNotification('تم حفظ بيانات رصد القنوات التلفزيونية بنجاح (القناة: ' + finalChannel + ', البرنامج: ' + finalProgramName + ', النوع: ' + finalProgramType + ')');
            
            // إعادة تعيين النموذج
            document.querySelector('#tvModal form').reset();
            closeModal('tvModal');
        }

        // Custom Select Functions
        function toggleCustomSelect(selectElement) {
            const optionsContainer = selectElement.nextElementSibling;
            const isOpen = optionsContainer.classList.contains('show');
            
            // Close all other custom selects
            document.querySelectorAll('.custom-options.show').forEach(options => {
                options.classList.remove('show');
                options.previousElementSibling.classList.remove('open');
            });
            
            if (!isOpen) {
                optionsContainer.classList.add('show');
                selectElement.classList.add('open');
            }
        }

        function selectOption(optionElement, value) {
            const container = optionElement.closest('.custom-select-container');
            const selectElement = container.querySelector('.custom-select');
            const selectedSpan = selectElement.querySelector('.selected-option');
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const optionsContainer = container.querySelector('.custom-options');
            
            selectedSpan.textContent = value;
            if (hiddenInput) {
                hiddenInput.value = value;
                console.log('Updated hidden input value to:', value);
            }
            
            // تحديث الحقل المخفي بـ ID webSite أيضاً للتأكد
            const webSiteInput = document.getElementById('webSite');
            if (webSiteInput) {
                webSiteInput.value = value;
                console.log('Updated webSite input value to:', value);
            }
            
            optionsContainer.classList.remove('show');
            selectElement.classList.remove('open');
            
            // تحديث الكيان فوراً
            console.log('selectOption called with value:', value);
            updateWebsiteEntityForSelect(value);
        }
        
        function updateWebsiteEntityForSelect(websiteName) {
            console.log('=== updateWebsiteEntityForSelect called ===');
            console.log('Website name received:', websiteName);
            
            const entityInput = document.getElementById('webEntityInput');
            console.log('Entity input found:', !!entityInput);
            
            if (!entityInput || !websiteName) {
                console.log('Early return: missing entityInput or websiteName');
                return;
            }
            
            // البحث في المواقع المضافة أولاً
            const customWebsites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
            console.log('Available custom websites:', customWebsites);
            console.log('Number of custom websites:', customWebsites.length);
            
            const customWebsite = customWebsites.find(site => {
                console.log('Comparing:', site.name, 'with', websiteName);
                return site.name && site.name.trim() === websiteName.trim();
            });
            
            console.log('Found custom website:', customWebsite);
            
            if (customWebsite && customWebsite.entity) {
                entityInput.value = customWebsite.entity;
                console.log('Entity updated successfully to:', customWebsite.entity);
                showNotification('تم تحديث الكيان تلقائياً: ' + customWebsite.entity, 'success');
                return;
            }
            
            // البحث في المواقع الافتراضية كبديل
            const defaultWebsites = {
                'الإصلاح نت': 'الإصلاح',
                'موقع المجلس الانتقالي': 'الانتقالي',
                'الصحوة نت': 'الإصلاح',
                'المسيرة نت': 'الحوثي',
                'سبأ نت': 'الحوثي',
                'الثورة نت': 'الحوثي'
            };
            
            console.log('Checking default websites for:', websiteName);
            if (defaultWebsites[websiteName]) {
                entityInput.value = defaultWebsites[websiteName];
                console.log('Entity updated from defaults to:', defaultWebsites[websiteName]);
                showNotification('تم تحديث الكيان تلقائياً: ' + defaultWebsites[websiteName], 'success');
            } else {
                entityInput.value = '';
                console.log('Website not found in any source');
                showNotification('لم يتم العثور على كيان لهذا الموقع', 'warning');
            }
            console.log('=== updateWebsiteEntityForSelect finished ===');
        }
        
        function selectChannelOption(optionElement, value) {
            const container = optionElement.closest('.custom-select-container');
            const selectElement = container.querySelector('.custom-select');
            const selectedSpan = selectElement.querySelector('.selected-option');
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const optionsContainer = container.querySelector('.custom-options');
            
            selectedSpan.textContent = value;
            hiddenInput.value = value;
            
            optionsContainer.classList.remove('show');
            selectElement.classList.remove('open');
            
            // تحديث الكيان للقناة
            const entityInput = document.getElementById('tvEntityInput');
            if (entityInput && value) {
                const customChannels = JSON.parse(localStorage.getItem('customChannels') || '[]');
                const customChannel = customChannels.find(channel => channel.name.trim() === value.trim());
                
                if (customChannel) {
                    entityInput.value = customChannel.entity;
                    showNotification('تم تحديث الكيان تلقائياً: ' + customChannel.entity, 'success');
                }
            }
        }

        // إغلاق القوائم المنسدلة عند النقر خارجها
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.custom-select-container')) {
                document.querySelectorAll('.custom-options.show').forEach(options => {
                    options.classList.remove('show');
                    options.previousElementSibling.classList.remove('open');
                });
            }
        });

        function submitAnalysis(event) {
            event.preventDefault();
            
            // الحصول على بيانات التحليل
            const analysisId = document.getElementById('analysisId').value;
            const analysisText = document.getElementById('analysisText').value;
            const recommendations = document.getElementById('recommendations').value;
            
            // التحقق من وجود نص التحليل
            if (!analysisText || analysisText.trim() === '') {
                showNotification('يرجى كتابة التحليل قبل الإرسال', 'error');
                return;
            }
            
            // إنشاء كائن التحليل
            const analysis = {
                id: 'ANALYSIS-' + Date.now(),
                analysisId: analysisId,
                text: analysisText.trim(),
                recommendations: recommendations ? recommendations.trim() : '',
                timestamp: new Date().toLocaleString('ar-SA'),
                date: new Date().toISOString().split('T')[0],
                status: 'sent'
            };
            
            // حفظ التحليل في localStorage
            let analyses = JSON.parse(localStorage.getItem('analyses') || '[]');
            analyses.push(analysis);
            localStorage.setItem('analyses', JSON.stringify(analyses));
            
            // إضافة التحليل كإشعار في صندوق وارد المدير
            let notifications = JSON.parse(localStorage.getItem('directorNotifications') || '[]');
            const notification = {
                id: Date.now(),
                source: 'المحلل الأول',
                type: 'analysis',
                priority: 'medium',
                time: 'الآن',
                content: analysisText.length > 100 ? analysisText.substring(0, 100) + '...' : analysisText,
                fullContent: analysisText,
                recommendations: recommendations,
                analysisId: analysisId,
                actions: ['approve', 'reject', 'consult', 'viewAnalysis'],
                timestamp: new Date().toISOString()
            };
            
            notifications.unshift(notification); // إضافة في المقدمة
            localStorage.setItem('directorNotifications', JSON.stringify(notifications));
            
            showNotification('تم إرسال التحليل إلى قيادة الدائرة بنجاح');
            
            // مسح النموذج
            document.getElementById('analysisText').value = '';
            if (document.getElementById('recommendations')) {
                document.getElementById('recommendations').value = '';
            }
        }

        // Export analysis to PDF with proper Arabic support
        function exportToPDF() {
            // Get analysis data
            const analysisId = document.getElementById('analysisId').value;
            const analysisText = document.getElementById('analysisText').value;
            const recommendations = document.getElementById('recommendations').value;
            const currentDate = new Date().toLocaleDateString('ar-EG');
            
            // Find the monitoring item
            const monitoringItem = monitoringData.find(item => item.id === analysisId);
            
            // Create HTML content for PDF with enhanced Arabic support
            const htmlContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;600;700&display=swap');
                        
                        * {
                            box-sizing: border-box;
                        }
                        
                        body { 
                            font-family: 'Noto Sans Arabic', 'Arial Unicode MS', 'Tahoma', 'DejaVu Sans', sans-serif; 
                            direction: rtl; 
                            text-align: right;
                            margin: 20px;
                            line-height: 1.8;
                            font-size: 14px;
                            color: #2c3e50;
                            background: white;
                            -webkit-font-smoothing: antialiased;
                            -moz-osx-font-smoothing: grayscale;
                        }
                        
                        .page {
                            max-width: 210mm;
                            margin: 0 auto;
                            padding: 20mm;
                            background: white;
                        }
                        
                        .header { 
                            text-align: center; 
                            margin-bottom: 40px;
                            border-bottom: 3px solid #3498db;
                            padding-bottom: 25px;
                        }
                        
                        .title { 
                            font-size: 28px; 
                            font-weight: 700; 
                            color: #2c3e50;
                            margin-bottom: 15px;
                            font-family: 'Noto Sans Arabic', sans-serif;
                        }
                        
                        .subtitle { 
                            font-size: 20px; 
                            color: #7f8c8d;
                            font-weight: 400;
                            margin-bottom: 10px;
                        }
                        
                        .date {
                            font-size: 16px;
                            color: #34495e;
                            font-weight: 600;
                            margin-top: 15px;
                        }
                        
                        .section { 
                            margin: 25px 0; 
                            padding: 20px;
                            border-right: 5px solid #3498db;
                            background-color: #f8f9fa;
                            border-radius: 8px;
                            page-break-inside: avoid;
                        }
                        
                        .section-title { 
                            font-size: 20px; 
                            font-weight: 700; 
                            color: #2c3e50;
                            margin-bottom: 15px;
                            font-family: 'Noto Sans Arabic', sans-serif;
                        }
                        
                        .content { 
                            font-size: 16px; 
                            color: #34495e;
                            white-space: pre-wrap;
                            line-height: 1.8;
                            font-family: 'Noto Sans Arabic', sans-serif;
                        }
                        
                        .footer { 
                            text-align: center; 
                            margin-top: 50px;
                            padding-top: 25px;
                            border-top: 2px solid #bdc3c7;
                            font-size: 14px;
                            color: #7f8c8d;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                            margin: 20px 0;
                        }
                        
                        .info-item {
                            padding: 12px;
                            background-color: #ecf0f1;
                            border-radius: 6px;
                            border-right: 3px solid #3498db;
                        }
                        
                        .info-label {
                            font-weight: 700;
                            color: #2c3e50;
                            font-size: 15px;
                            font-family: 'Noto Sans Arabic', sans-serif;
                        }
                        
                        .info-value {
                            color: #34495e;
                            font-size: 15px;
                            margin-right: 8px;
                        }
                        
                        @media print {
                            body {
                                margin: 0;
                                font-size: 12px;
                            }
                            .page {
                                margin: 0;
                                padding: 15mm;
                                max-width: none;
                            }
                            .section {
                                page-break-inside: avoid;
                            }
                        }
                        
                        /* Ensure proper Arabic text rendering */
                        .arabic-text {
                            unicode-bidi: bidi-override;
                            direction: rtl;
                            text-align: right;
                        }
                    </style>
                </head>
                <body>
                    <div class="page">
                        <div class="header">
                            <div class="title arabic-text">تقرير تحليل العمليات الإعلامية</div>
                            <div class="subtitle">Media Operations Analysis Report</div>
                            <div class="date arabic-text">التاريخ: ${currentDate}</div>
                        </div>
                        
                        ${monitoringItem ? `
                        <div class="section">
                            <div class="section-title arabic-text">تفاصيل المحتوى المرصود</div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label arabic-text">رقم المحتوى:</span>
                                    <span class="info-value">${monitoringItem.id}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label arabic-text">المصدر:</span>
                                    <span class="info-value arabic-text">${monitoringItem.source}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label arabic-text">الكيان:</span>
                                    <span class="info-value arabic-text">${monitoringItem.entity}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label arabic-text">الملف:</span>
                                    <span class="info-value arabic-text">${monitoringItem.file}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label arabic-text">الأولوية:</span>
                                    <span class="info-value arabic-text">${monitoringItem.priority}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label arabic-text">التاريخ:</span>
                                    <span class="info-value">${monitoringItem.date}</span>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <div class="info-label arabic-text">المحتوى المرصود:</div>
                                <div class="content arabic-text" style="margin-top: 10px; padding: 15px; background: white; border-radius: 6px;">${monitoringItem.content}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="section">
                            <div class="section-title arabic-text">التحليل</div>
                            <div class="content arabic-text">${analysisText || 'لم يتم تقديم تحليل'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title arabic-text">التوصيات</div>
                            <div class="content arabic-text">${recommendations || 'لم يتم تقديم توصيات'}</div>
                        </div>
                        
                        <div class="footer">
                            <div class="arabic-text">تم إنشاؤه بواسطة نظام إدارة العمليات الإعلامية</div>
                            <div style="margin-top: 5px;">Generated by Media Operations Management System</div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // Create a new window for PDF export
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            
            // Write content to the new window
            printWindow.document.open();
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Wait for fonts and content to load, then trigger print
            printWindow.onload = function() {
                // Additional wait for Google Fonts to load
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    
                    // Close window after printing (optional)
                    setTimeout(() => {
                        printWindow.close();
                    }, 1000);
                }, 1500); // Increased timeout for font loading
            };
            
            showNotification('تم فتح نافذة الطباعة - يمكنك حفظ التقرير كـ PDF من خيارات الطباعة');
        }

        // Media Management Functions
        function openMediaManagement() {
            document.getElementById('mediaManagementModal').style.display = 'block';
            loadMediaLists();
            updateFileOptions(); // تحديث قوائم الملفات في جميع النماذج
            updateIssueOptions(); // تحديث قوائم القضايا في جميع النماذج
            updatePublishLevelOptions(); // تحديث قوائم مستوى النشر في جميع النماذج
        }

        function closeMediaManagement() {
            document.getElementById('mediaManagementModal').style.display = 'none';
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Load data for the selected tab
            if (tabName === 'websites') {
                loadWebsitesList();
            } else if (tabName === 'channels') {
                loadChannelsList();
            } else if (tabName === 'files') {
                loadFilesList();
            } else if (tabName === 'issues') {
                loadIssuesList();
            }
        }

        function addNewWebsite() {
            const name = document.getElementById('newWebsiteName').value.trim();
            const entity = document.getElementById('newWebsiteEntity').value;

            if (!name || !entity) {
                showNotification('يرجى إدخال اسم الموقع والكيان التابع له');
                return;
            }

            // Get existing websites
            let websites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
            
            // Check if website already exists
            if (websites.some(site => site.name === name)) {
                showNotification('هذا الموقع موجود بالفعل');
                return;
            }

            // Add new website
            websites.push({ name, entity });
            localStorage.setItem('customWebsites', JSON.stringify(websites));

            // Clear form
            document.getElementById('newWebsiteName').value = '';
            document.getElementById('newWebsiteEntity').value = '';

            // Reload lists
            loadMediaLists();
            updateWebsiteOptions();
            
            showNotification('تم إضافة الموقع بنجاح');
        }

        function addNewWebsite2() {
            const name = document.getElementById('newWebsiteName2').value.trim();
            const entity = document.getElementById('newWebsiteEntity2').value;
            const publishLevel = document.getElementById('newWebsitePublishLevel2').value;

            if (!name || !entity || !publishLevel) {
                showNotification('يرجى إدخال جميع البيانات المطلوبة (اسم الموقع، الكيان، مستوى النشر)');
                return;
            }

            // Get existing websites
            let websites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
            
            // Check if website already exists
            if (websites.some(site => site.name === name)) {
                showNotification('هذا الموقع موجود بالفعل');
                return;
            }

            // Add new website with publish level
            websites.push({ name, entity, publishLevel });
            localStorage.setItem('customWebsites', JSON.stringify(websites));

            // Clear form
            document.getElementById('newWebsiteName2').value = '';
            document.getElementById('newWebsiteEntity2').value = '';
            document.getElementById('newWebsitePublishLevel2').value = '';

            // Reload lists
            loadMediaLists();
            updateWebsiteOptions();
            
            showNotification('تم إضافة الموقع بنجاح');
        }

        function addNewChannel() {
            const name = document.getElementById('newChannelName').value.trim();
            const entity = document.getElementById('newChannelEntity').value;

            if (!name || !entity) {
                showNotification('يرجى إدخال اسم القناة والكيان التابع لها');
                return;
            }

            // Get existing channels
            let channels = JSON.parse(localStorage.getItem('customChannels') || '[]');
            
            // Check if channel already exists
            if (channels.some(channel => channel.name === name)) {
                showNotification('هذه القناة موجودة بالفعل');
                return;
            }

            // Add new channel
            channels.push({ name, entity });
            localStorage.setItem('customChannels', JSON.stringify(channels));

            // Clear form
            document.getElementById('newChannelName').value = '';
            document.getElementById('newChannelEntity').value = '';

            // Reload lists
            loadMediaLists();
            updateChannelOptions();
            
            showNotification('تم إضافة القناة بنجاح');
        }

        function addNewChannel2() {
            const name = document.getElementById('newChannelName2').value.trim();
            const entity = document.getElementById('newChannelEntity2').value;
            const publishLevel = document.getElementById('newChannelPublishLevel2').value;

            if (!name || !entity || !publishLevel) {
                showNotification('يرجى إدخال جميع البيانات المطلوبة (اسم القناة، الكيان، مستوى النشر)');
                return;
            }

            // Get existing channels
            let channels = JSON.parse(localStorage.getItem('customChannels') || '[]');
            
            // Check if channel already exists
            if (channels.some(channel => channel.name === name)) {
                showNotification('هذه القناة موجودة بالفعل');
                return;
            }

            // Add new channel with publish level
            channels.push({ name, entity, publishLevel });
            localStorage.setItem('customChannels', JSON.stringify(channels));

            // Clear form
            document.getElementById('newChannelName2').value = '';
            document.getElementById('newChannelEntity2').value = '';
            document.getElementById('newChannelPublishLevel2').value = '';

            // Reload lists
            loadMediaLists();
            updateChannelOptions();
            
            showNotification('تم إضافة القناة بنجاح');
        }

        function loadMediaLists() {
            loadWebsitesList();
            loadChannelsList();
            loadFilesList();
            loadIssuesList();
            loadPublishLevelsList(); // إضافة تحديث قائمة مستوى النشر
            updateIssueOptions(); // تحديث قوائم القضايا في جميع النماذج
            updatePublishLevelOptions(); // تحديث قوائم مستوى النشر في جميع النماذج
        }

        function loadWebsitesList() {
            const websites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
            const websitesList = document.getElementById('websitesList');
            
            websitesList.innerHTML = '';
            
            websites.forEach((website, index) => {
                const item = document.createElement('div');
                item.className = 'media-item';
                item.innerHTML = `
                    <div class="media-info">
                        <div class="media-name">${website.name}</div>
                        <div class="media-entity">الكيان: ${website.entity}</div>
                        <div class="media-entity">مستوى النشر: ${website.publishLevel || 'غير محدد'}</div>
                    </div>
                    <div class="media-actions">
                        <button class="edit-media-btn" onclick="editWebsite(${index})">تعديل</button>
                        <button class="delete-media-btn" onclick="deleteWebsite(${index})">حذف</button>
                    </div>
                `;
                websitesList.appendChild(item);
            });
        }

        function loadChannelsList() {
            const channels = JSON.parse(localStorage.getItem('customChannels') || '[]');
            const channelsList = document.getElementById('channelsList');
            
            channelsList.innerHTML = '';
            
            channels.forEach((channel, index) => {
                const item = document.createElement('div');
                item.className = 'media-item';
                item.innerHTML = `
                    <div class="media-info">
                        <div class="media-name">${channel.name}</div>
                        <div class="media-entity">الكيان: ${channel.entity}</div>
                        <div class="media-entity">مستوى النشر: ${channel.publishLevel || 'غير محدد'}</div>
                    </div>
                    <div class="media-actions">
                        <button class="edit-media-btn" onclick="editChannel(${index})">تعديل</button>
                        <button class="delete-media-btn" onclick="deleteChannel(${index})">حذف</button>
                    </div>
                `;
                channelsList.appendChild(item);
            });
        }

        function editWebsite(index) {
            const websites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
            const website = websites[index];
            
            // إنشاء نافذة تعديل مخصصة
            const editModal = document.createElement('div');
            editModal.className = 'modal';
            editModal.style.display = 'block';
            editModal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>تعديل الموقع</h3>
                    <div class="form-group">
                        <label>اسم الموقع:</label>
                        <input type="text" id="editWebsiteName" value="${website.name}">
                    </div>
                    <div class="form-group">
                        <label>الكيان التابع له:</label>
                        <select id="editWebsiteEntity">
                            <option value="">اختر الكيان</option>
                            <option value="الحكومة" ${website.entity === 'الحكومة' ? 'selected' : ''}>الحكومة</option>
                            <option value="الحوثي" ${website.entity === 'الحوثي' ? 'selected' : ''}>الحوثي</option>
                            <option value="الإصلاح" ${website.entity === 'الإصلاح' ? 'selected' : ''}>الإصلاح</option>
                            <option value="الانتقالي" ${website.entity === 'الانتقالي' ? 'selected' : ''}>الانتقالي</option>
                            <option value="مؤتمر صنعاء" ${website.entity === 'مؤتمر صنعاء' ? 'selected' : ''}>مؤتمر صنعاء</option>
                            <option value="مؤتمر الساحل" ${website.entity === 'مؤتمر الساحل' ? 'selected' : ''}>مؤتمر الساحل</option>
                            <option value="الناصري" ${website.entity === 'الناصري' ? 'selected' : ''}>الناصري</option>
                            <option value="البعث" ${website.entity === 'البعث' ? 'selected' : ''}>البعث</option>
                            <option value="الاشتراكي" ${website.entity === 'الاشتراكي' ? 'selected' : ''}>الاشتراكي</option>
                            <option value="حلف حضرموت" ${website.entity === 'حلف حضرموت' ? 'selected' : ''}>حلف حضرموت</option>
                            <option value="الإمارات" ${website.entity === 'الإمارات' ? 'selected' : ''}>الإمارات</option>
                            <option value="السعودية" ${website.entity === 'السعودية' ? 'selected' : ''}>السعودية</option>
                            <option value="التحالف" ${website.entity === 'التحالف' ? 'selected' : ''}>التحالف</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button onclick="saveWebsiteEdit(${index})" class="add-btn">حفظ التعديلات</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="cancel-btn">إلغاء</button>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
        }

        function saveWebsiteEdit(index) {
            const newName = document.getElementById('editWebsiteName').value.trim();
            const newEntity = document.getElementById('editWebsiteEntity').value;
            
            if (newName && newEntity) {
                const websites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
                websites[index].name = newName;
                websites[index].entity = newEntity;
                localStorage.setItem('customWebsites', JSON.stringify(websites));
                loadMediaLists();
                updateWebsiteOptions();
                showNotification('تم تحديث الموقع بنجاح');
                
                // إغلاق النافذة
                document.querySelector('.modal').remove();
            } else {
                showNotification('يرجى ملء جميع الحقول');
            }
        }

        function editChannel(index) {
            const channels = JSON.parse(localStorage.getItem('customChannels') || '[]');
            const channel = channels[index];
            
            // إنشاء نافذة تعديل مخصصة للقنوات
            const editModal = document.createElement('div');
            editModal.className = 'modal';
            editModal.style.display = 'block';
            editModal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>تعديل القناة</h3>
                    <div class="form-group">
                        <label>اسم القناة:</label>
                        <input type="text" id="editChannelName" value="${channel.name}">
                    </div>
                    <div class="form-group">
                        <label>الكيان التابع لها:</label>
                        <select id="editChannelEntity">
                            <option value="">اختر الكيان</option>
                            <option value="الحكومة" ${channel.entity === 'الحكومة' ? 'selected' : ''}>الحكومة</option>
                            <option value="الحوثي" ${channel.entity === 'الحوثي' ? 'selected' : ''}>الحوثي</option>
                            <option value="الإصلاح" ${channel.entity === 'الإصلاح' ? 'selected' : ''}>الإصلاح</option>
                            <option value="الانتقالي" ${channel.entity === 'الانتقالي' ? 'selected' : ''}>الانتقالي</option>
                            <option value="مؤتمر صنعاء" ${channel.entity === 'مؤتمر صنعاء' ? 'selected' : ''}>مؤتمر صنعاء</option>
                            <option value="مؤتمر الساحل" ${channel.entity === 'مؤتمر الساحل' ? 'selected' : ''}>مؤتمر الساحل</option>
                            <option value="الناصري" ${channel.entity === 'الناصري' ? 'selected' : ''}>الناصري</option>
                            <option value="البعث" ${channel.entity === 'البعث' ? 'selected' : ''}>البعث</option>
                            <option value="الاشتراكي" ${channel.entity === 'الاشتراكي' ? 'selected' : ''}>الاشتراكي</option>
                            <option value="حلف حضرموت" ${channel.entity === 'حلف حضرموت' ? 'selected' : ''}>حلف حضرموت</option>
                            <option value="الإمارات" ${channel.entity === 'الإمارات' ? 'selected' : ''}>الإمارات</option>
                            <option value="السعودية" ${channel.entity === 'السعودية' ? 'selected' : ''}>السعودية</option>
                            <option value="التحالف" ${channel.entity === 'التحالف' ? 'selected' : ''}>التحالف</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button onclick="saveChannelEdit(${index})" class="add-btn">حفظ التعديلات</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="cancel-btn">إلغاء</button>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
        }

        function saveChannelEdit(index) {
            const newName = document.getElementById('editChannelName').value.trim();
            const newEntity = document.getElementById('editChannelEntity').value;
            
            if (newName && newEntity) {
                const channels = JSON.parse(localStorage.getItem('customChannels') || '[]');
                channels[index].name = newName;
                channels[index].entity = newEntity;
                localStorage.setItem('customChannels', JSON.stringify(channels));
                loadMediaLists();
                updateChannelOptions();
                showNotification('تم تحديث القناة بنجاح');
                
                // إغلاق النافذة
                document.querySelector('.modal').remove();
            } else {
                showNotification('يرجى ملء جميع الحقول');
            }
        }

        function deleteWebsite(index) {
            // استخدام نظام التأكيد المخصص بدلاً من confirm
            showConfirmDialog('هل أنت متأكد من حذف هذا الموقع؟', () => {
                const websites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
                websites.splice(index, 1);
                localStorage.setItem('customWebsites', JSON.stringify(websites));
                loadMediaLists();
                updateWebsiteOptions();
                showNotification('تم حذف الموقع بنجاح');
            });
        }

        function deleteChannel(index) {
            // استخدام نظام التأكيد المخصص بدلاً من confirm
            showConfirmDialog('هل أنت متأكد من حذف هذه القناة؟', () => {
                const channels = JSON.parse(localStorage.getItem('customChannels') || '[]');
                channels.splice(index, 1);
                localStorage.setItem('customChannels', JSON.stringify(channels));
                loadMediaLists();
                updateChannelOptions();
                showNotification('تم حذف القناة بنجاح');
            });
        }

        // Files Management Functions
        function addNewFile() {
            const name = document.getElementById('newFileName').value.trim();

            if (!name) {
                showNotification('يرجى إدخال اسم الملف');
                return;
            }

            // Get existing files
            const files = JSON.parse(localStorage.getItem('customFiles') || '[]');
            
            // Check if file already exists
            if (files.some(file => file.name === name)) {
                showNotification('هذا الملف موجود بالفعل');
                return;
            }

            // Add new file
            files.push({ name: name });
            localStorage.setItem('customFiles', JSON.stringify(files));

            // Clear input
            document.getElementById('newFileName').value = '';

            // Refresh lists
            loadFilesList();
            updateFileOptions();
            
            showNotification('تم إضافة الملف بنجاح');
        }

        function loadFilesList() {
            const files = JSON.parse(localStorage.getItem('customFiles') || '[]');
            const filesList = document.getElementById('filesList');
            
            filesList.innerHTML = '';
            
            files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'media-item';
                item.innerHTML = `
                    <div class="media-info">
                        <div class="media-name">${file.name}</div>
                    </div>
                    <div class="media-actions">
                        <button class="edit-media-btn" onclick="editFile(${index})">تعديل</button>
                        <button class="delete-media-btn" onclick="deleteFile(${index})">حذف</button>
                    </div>
                `;
                filesList.appendChild(item);
            });
        }

        function editFile(index) {
            const files = JSON.parse(localStorage.getItem('customFiles') || '[]');
            const file = files[index];
            
            // إنشاء نافذة تعديل مخصصة للملفات
            const editModal = document.createElement('div');
            editModal.className = 'modal';
            editModal.style.display = 'block';
            editModal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>تعديل الملف</h3>
                    <div class="form-group">
                        <label>اسم الملف:</label>
                        <input type="text" id="editFileName" value="${file.name}">
                    </div>
                    <div class="form-group">
                        <button type="button" class="add-btn" onclick="saveFileEdit(${index}); this.parentElement.parentElement.parentElement.remove();">حفظ التعديل</button>
                        <button type="button" class="cancel-btn" onclick="this.parentElement.parentElement.parentElement.remove();">إلغاء</button>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
        }

        function saveFileEdit(index) {
            const newName = document.getElementById('editFileName').value.trim();
            
            if (!newName) {
                showNotification('يرجى إدخال اسم الملف');
                return;
            }

            const files = JSON.parse(localStorage.getItem('customFiles') || '[]');
            
            // Check if new name already exists (excluding current file)
            if (files.some((file, i) => file.name === newName && i !== index)) {
                showNotification('هذا الاسم موجود بالفعل');
                return;
            }

            files[index].name = newName;
            localStorage.setItem('customFiles', JSON.stringify(files));
            
            loadFilesList();
            updateFileOptions();
            showNotification('تم تعديل الملف بنجاح');
        }

        function deleteFile(index) {
            // استخدام نظام التأكيد المخصص بدلاً من confirm
            showConfirmDialog('هل أنت متأكد من حذف هذا الملف؟', () => {
                const files = JSON.parse(localStorage.getItem('customFiles') || '[]');
                files.splice(index, 1);
                localStorage.setItem('customFiles', JSON.stringify(files));
                loadFilesList();
                updateFileOptions();
                showNotification('تم حذف الملف بنجاح');
            });
        }

        function updateFileOptions() {
            // تحديث جميع القوائم المنسدلة للملفات في النظام
            const files = JSON.parse(localStorage.getItem('customFiles') || '[]');
            
            // تحديث جميع قوائم الملفات في النماذج
            const fileSelects = ['socialFile', 'webFile', 'tvFile'];
            
            fileSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // مسح الخيارات الموجودة (عدا الخيار الأول)
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    // إضافة الملفات من localStorage فقط
                    files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.name;
                        option.textContent = file.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Issues Management Functions
        function addNewIssue() {
            const name = document.getElementById('newIssueName').value.trim();

            if (!name) {
                showNotification('يرجى إدخال اسم القضية');
                return;
            }

            // Get existing issues
            const issues = JSON.parse(localStorage.getItem('customIssues') || '[]');
            
            // Check if issue already exists
            if (issues.some(issue => issue.name === name)) {
                showNotification('هذه القضية موجودة بالفعل');
                return;
            }

            // Add new issue
            issues.push({ name: name });
            localStorage.setItem('customIssues', JSON.stringify(issues));

            // Clear input
            document.getElementById('newIssueName').value = '';

            // Refresh lists
            loadIssuesList();
            updateIssueOptions();
            
            showNotification('تم إضافة القضية بنجاح');
        }

        // Publish Levels Management Functions
        function addNewPublishLevel() {
            const name = document.getElementById('newPublishLevelName').value.trim();

            if (!name) {
                showNotification('يرجى إدخال اسم مستوى النشر');
                return;
            }

            // Get existing publish levels
            const publishLevels = JSON.parse(localStorage.getItem('customPublishLevels') || '[]');
            
            // Check if publish level already exists
            if (publishLevels.some(level => level.name === name)) {
                showNotification('هذا المستوى موجود بالفعل');
                return;
            }

            // Add new publish level
            publishLevels.push({ name: name });
            localStorage.setItem('customPublishLevels', JSON.stringify(publishLevels));

            // Clear input
            document.getElementById('newPublishLevelName').value = '';

            // Refresh lists
            loadPublishLevelsList();
            updatePublishLevelOptions();
            
            showNotification('تم إضافة مستوى النشر بنجاح');
        }

        function loadPublishLevelsList() {
            const publishLevels = JSON.parse(localStorage.getItem('customPublishLevels') || '[]');
            const publishLevelsList = document.getElementById('publishLevelsList');
            
            publishLevelsList.innerHTML = '';
            
            publishLevels.forEach((level, index) => {
                const item = document.createElement('div');
                item.className = 'media-item';
                item.innerHTML = `
                    <div class="media-info">
                        <div class="media-name">${level.name}</div>
                    </div>
                    <div class="media-actions">
                        <button class="edit-media-btn" onclick="editPublishLevel(${index})">تعديل</button>
                        <button class="delete-media-btn" onclick="deletePublishLevel(${index})">حذف</button>
                    </div>
                `;
                publishLevelsList.appendChild(item);
            });
        }

        function editPublishLevel(index) {
            const publishLevels = JSON.parse(localStorage.getItem('customPublishLevels') || '[]');
            const level = publishLevels[index];
            
            // إنشاء نافذة تعديل مخصصة لمستويات النشر
            const editModal = document.createElement('div');
            editModal.className = 'modal';
            editModal.style.display = 'block';
            editModal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>تعديل مستوى النشر</h3>
                    <div class="form-group">
                        <label>اسم مستوى النشر:</label>
                        <input type="text" id="editPublishLevelName" value="${level.name}">
                    </div>
                    <div class="form-group">
                        <button type="button" class="add-btn" onclick="savePublishLevelEdit(${index}); this.parentElement.parentElement.parentElement.remove();">حفظ التعديل</button>
                        <button type="button" class="cancel-btn" onclick="this.parentElement.parentElement.parentElement.remove();">إلغاء</button>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
        }

        function savePublishLevelEdit(index) {
            const newName = document.getElementById('editPublishLevelName').value.trim();
            
            if (!newName) {
                showNotification('يرجى إدخال اسم مستوى النشر');
                return;
            }

            const publishLevels = JSON.parse(localStorage.getItem('customPublishLevels') || '[]');
            
            // Check if new name already exists (excluding current level)
            if (publishLevels.some((level, i) => level.name === newName && i !== index)) {
                showNotification('هذا الاسم موجود بالفعل');
                return;
            }

            publishLevels[index].name = newName;
            localStorage.setItem('customPublishLevels', JSON.stringify(publishLevels));
            
            loadPublishLevelsList();
            updatePublishLevelOptions();
            showNotification('تم تعديل مستوى النشر بنجاح');
        }

        function deletePublishLevel(index) {
            // استخدام نظام التأكيد المخصص بدلاً من confirm
            showConfirmDialog('هل أنت متأكد من حذف مستوى النشر هذا؟', () => {
                const publishLevels = JSON.parse(localStorage.getItem('customPublishLevels') || '[]');
                publishLevels.splice(index, 1);
                localStorage.setItem('customPublishLevels', JSON.stringify(publishLevels));
                loadPublishLevelsList();
                updatePublishLevelOptions();
                showNotification('تم حذف مستوى النشر بنجاح');
            });
        }

        function updatePublishLevelOptions() {
            // تحديث جميع القوائم المنسدلة لمستويات النشر في النظام
            const publishLevels = JSON.parse(localStorage.getItem('customPublishLevels') || '[]');
            
            // تحديث جميع قوائم مستويات النشر في النماذج
            const publishLevelSelects = ['socialPublishLevel', 'webPublishLevel', 'tvPublishLevel', 'newWebsitePublishLevel2', 'newChannelPublishLevel2'];
            
            publishLevelSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // مسح الخيارات الموجودة (عدا الخيار الأول)
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    // إضافة مستويات النشر من localStorage فقط
                    publishLevels.forEach(level => {
                        const option = document.createElement('option');
                        option.value = level.name;
                        option.textContent = level.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        function loadIssuesList() {
            const issues = JSON.parse(localStorage.getItem('customIssues') || '[]');
            const issuesList = document.getElementById('issuesList');
            
            issuesList.innerHTML = '';
            
            issues.forEach((issue, index) => {
                const item = document.createElement('div');
                item.className = 'media-item';
                item.innerHTML = `
                    <div class="media-info">
                        <strong>${issue.name}</strong>
                    </div>
                    <div class="media-actions">
                        <button class="edit-btn" onclick="editIssue(${index})">تعديل</button>
                        <button class="delete-btn" onclick="deleteIssue(${index})">حذف</button>
                    </div>
                `;
                issuesList.appendChild(item);
            });
            
            if (issues.length === 0) {
                issuesList.innerHTML = '<p style="text-align: center; color: #666;">لا توجد قضايا مضافة</p>';
            }
        }

        function editIssue(index) {
            const issues = JSON.parse(localStorage.getItem('customIssues') || '[]');
            const issue = issues[index];
            
            const newName = prompt('تعديل اسم القضية:', issue.name);
            if (newName && newName.trim() !== '') {
                // Check if new name already exists (excluding current issue)
                const otherIssues = issues.filter((_, i) => i !== index);
                if (otherIssues.some(i => i.name === newName.trim())) {
                    showNotification('هذا الاسم موجود بالفعل');
                    return;
                }
                
                issues[index].name = newName.trim();
                localStorage.setItem('customIssues', JSON.stringify(issues));
                loadIssuesList();
                updateIssueOptions();
                showNotification('تم تعديل القضية بنجاح');
            }
        }

        function deleteIssue(index) {
            // استخدام نظام التأكيد المخصص بدلاً من confirm
            showConfirmDialog('هل أنت متأكد من حذف هذه القضية؟', () => {
                const issues = JSON.parse(localStorage.getItem('customIssues') || '[]');
                issues.splice(index, 1);
                localStorage.setItem('customIssues', JSON.stringify(issues));
                loadIssuesList();
                updateIssueOptions();
                showNotification('تم حذف القضية بنجاح');
            });
        }

        function updateIssueOptions() {
            // تحديث جميع القوائم المنسدلة للقضايا في النظام
            const issues = JSON.parse(localStorage.getItem('customIssues') || '[]');
            const issueSelects = document.querySelectorAll('select[id*="Issue"], select[id*="issue"], select[name*="issue"]');
            
            // القضايا الافتراضية
            const defaultIssues = [
                'الانتخابات',
                'الاقتصاد', 
                'التعليم',
                'الصحة',
                'البيئة',
                'حقوق الإنسان',
                'الأمن',
                'الفساد'
            ];
            
            issueSelects.forEach(select => {
                // Clear all options except the first one (placeholder)
                const firstOption = select.querySelector('option[key="0"]');
                select.innerHTML = '';
                if (firstOption) {
                    select.appendChild(firstOption);
                }
                
                // Add custom issues first
                if (issues.length > 0) {
                    issues.forEach(issue => {
                        const option = document.createElement('option');
                        option.value = issue.name;
                        option.textContent = issue.name;
                        option.setAttribute('data-custom', 'true');
                        select.appendChild(option);
                    });
                } else {
                    // Add default issues if no custom issues exist
                    defaultIssues.forEach(issueName => {
                        const option = document.createElement('option');
                        option.value = issueName;
                        option.textContent = issueName;
                        option.setAttribute('data-default', 'true');
                        select.appendChild(option);
                    });
                }
            });
        }

        function updateWebsiteOptions() {
            // تحديث القائمة المنسدلة المخصصة للمواقع
            updateCustomWebsiteSelect();
            
            // تحديث القائمة المنسدلة العادية (للتوافق مع الكود القديم)
            const websites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
            const webSelect = document.getElementById('webSite');
            
            if (webSelect) {
                // Remove existing custom options
                const customOptions = webSelect.querySelectorAll('option[data-custom="true"]');
                customOptions.forEach(option => option.remove());
                
                // Add new custom options
                websites.forEach(website => {
                    const option = document.createElement('option');
                    option.value = website.name;
                    option.textContent = website.name;
                    option.setAttribute('data-custom', 'true');
                    webSelect.appendChild(option);
                });
            }
        }

        function updateCustomWebsiteSelect() {
            const customWebsites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
            const optionsContainer = document.getElementById('websiteCustomOptions');
            
            if (!optionsContainer) return;
            
            // مسح المحتوى الحالي
            optionsContainer.innerHTML = '';
            
            // إضافة المواقع المضافة فقط
            if (customWebsites.length > 0) {
                const customCategoryDiv = document.createElement('div');
                customCategoryDiv.className = 'option-category green';
                customCategoryDiv.textContent = 'المواقع المضافة';
                optionsContainer.appendChild(customCategoryDiv);
                
                customWebsites.forEach(website => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-item';
                    optionDiv.textContent = website.name;
                    optionDiv.setAttribute('data-entity', website.entity);
                    optionDiv.addEventListener('click', function() { 
                        console.log('=== CUSTOM WEBSITE CLICKED ===');
                        console.log('Clicked on custom website:', website.name);
                        selectOption(this, website.name);
                    });
                    optionsContainer.appendChild(optionDiv);
                });
            } else {
                // إذا لم توجد مواقع مضافة، عرض مواقع افتراضية
                const defaultSites = [
                    { name: 'المسيرة نت', entity: 'الحوثي' },
                    { name: 'سبأ نت', entity: 'الحوثي' },
                    { name: 'الإصلاح نت', entity: 'الإصلاح' },
                    { name: 'الصحوة نت', entity: 'الإصلاح' },
                    { name: 'موقع المجلس الانتقالي', entity: 'الانتقالي' }
                ];
                
                const defaultCategoryDiv = document.createElement('div');
                defaultCategoryDiv.className = 'option-category blue';
                defaultCategoryDiv.textContent = 'مواقع افتراضية';
                optionsContainer.appendChild(defaultCategoryDiv);
                
                defaultSites.forEach(website => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-item';
                    optionDiv.textContent = website.name;
                    optionDiv.setAttribute('data-entity', website.entity);
                    optionDiv.addEventListener('click', function() { 
                        console.log('=== DEFAULT WEBSITE CLICKED ===');
                        console.log('Clicked on website:', website.name);
                        selectOption(this, website.name);
                    });
                    optionsContainer.appendChild(optionDiv);
                });
                
                const addSiteDiv = document.createElement('div');
                addSiteDiv.className = 'option-category gray';
                addSiteDiv.textContent = 'يمكنك إضافة مواقع مخصصة من إدارة الوسائل';
                addSiteDiv.style.fontSize = '12px';
                addSiteDiv.style.fontStyle = 'italic';
                addSiteDiv.style.color = '#666';
                optionsContainer.appendChild(addSiteDiv);
            }
        }

        function updateChannelOptions() {
            const channels = JSON.parse(localStorage.getItem('customChannels') || '[]');
            const channelOptionsContainer = document.getElementById('tvChannelOptions');
            
            if (channelOptionsContainer) {
                // مسح الخيارات الموجودة
                channelOptionsContainer.innerHTML = '';
                
                // إضافة قسم القنوات المضافة
                if (channels.length > 0) {
                    const addedChannelsHeader = document.createElement('div');
                    addedChannelsHeader.className = 'option-group-header';
                    addedChannelsHeader.textContent = 'القنوات المضافة';
                    addedChannelsHeader.style.backgroundColor = '#28a745';
                    addedChannelsHeader.style.color = 'white';
                    addedChannelsHeader.style.padding = '8px 12px';
                    addedChannelsHeader.style.fontWeight = 'bold';
                    addedChannelsHeader.style.fontSize = '14px';
                    channelOptionsContainer.appendChild(addedChannelsHeader);
                    
                    // إضافة القنوات المضافة
                    channels.forEach(channel => {
                        const option = document.createElement('div');
                        option.className = 'custom-option';
                        option.textContent = channel.name;
                        option.onclick = () => selectChannelOption(option, channel.name);
                        channelOptionsContainer.appendChild(option);
                    });
                }
            }
        }

        function selectChannelOption(optionElement, value) {
            const container = optionElement.closest('.custom-select-container');
            const selectElement = container.querySelector('.custom-select');
            const selectedSpan = selectElement.querySelector('.selected-option');
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const optionsContainer = container.querySelector('.custom-options');
            
            selectedSpan.textContent = value;
            hiddenInput.value = value;
            
            optionsContainer.classList.remove('show');
            selectElement.classList.remove('open');
            
            // تحديث فوري ومباشر للكيان
            const entityInput = document.getElementById('tvEntityInput');
            if (entityInput && value) {
                console.log('Updating entity for channel:', value);
                
                // البحث في القنوات المضافة
                const customChannels = JSON.parse(localStorage.getItem('customChannels') || '[]');
                console.log('Available custom channels:', customChannels);
                
                const customChannel = customChannels.find(channel => channel.name === value);
                
                if (customChannel) {
                    entityInput.value = customChannel.entity;
                    entityInput.readOnly = true;
                    console.log('Entity updated successfully to:', customChannel.entity);
                    
                    // إشعار للمستخدم
                    showNotification('تم تحديث الكيان تلقائياً: ' + customChannel.entity, 'success');
                } else {
                    console.log('Channel not found in custom channels');
                    entityInput.value = '';
                    entityInput.readOnly = true;
                }
            }
        }

        // Logout function
        function logout() {
            document.querySelectorAll('.dashboard').forEach(dashboard => {
                dashboard.classList.remove('active');
            });
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Notification function
        function showNotification(message) {
            const toast = document.getElementById('notificationToast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Confirm dialog function
        function showConfirmDialog(message, onConfirm) {
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'modal';
            confirmDialog.style.display = 'block';
            confirmDialog.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <h3>تأكيد العملية</h3>
                    <p style="margin: 20px 0; font-size: 16px;">${message}</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="confirmAction()" style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">نعم</button>
                        <button onclick="cancelAction()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">إلغاء</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            window.confirmAction = function() {
                onConfirm();
                document.body.removeChild(confirmDialog);
                delete window.confirmAction;
                delete window.cancelAction;
            };
            
            window.cancelAction = function() {
                document.body.removeChild(confirmDialog);
                delete window.confirmAction;
                delete window.cancelAction;
            };
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // إخفاء جميع لوحات التحكم وعرض نموذج تسجيل الدخول عند تحميل الصفحة
            document.querySelectorAll(".dashboard").forEach(dashboard => {
                dashboard.classList.remove("active");
            });
            document.getElementById("loginForm").style.display = "block";
            
            // Load custom media options
            updateWebsiteOptions();
            updateChannelOptions();
            updateFileOptions(); // تحديث قوائم الملفات
            updateIssueOptions(); // تحديث قوائم القضايا
            updatePublishLevelOptions(); // تحديث قوائم مستوى النشر
            
            // Set today's date as default for date inputs
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });

            // Auto-refresh notifications every 30 seconds
            setInterval(() => {
                if (document.getElementById('directorDashboard').classList.contains('active')) {
                    // In a real application, this would fetch new notifications from the server
                    console.log('Checking for new notifications...');
                }
            }, 30000);
        });

        // دالة عرض تفاصيل التحليل والرصد المعتمد عليه
        function viewAnalysisDetails(notificationId, button) {
            // البحث عن الإشعار في localStorage
            const notifications = JSON.parse(localStorage.getItem('directorNotifications') || '[]');
            const notification = notifications.find(n => n.id === notificationId);
            
            if (!notification) {
                showNotification('لم يتم العثور على التحليل المطلوب', 'error');
                return;
            }

            // البحث عن البيانات المرصودة المرتبطة بالتحليل
            const monitoringData = JSON.parse(localStorage.getItem('monitoringData') || '[]');
            const relatedMonitoring = monitoringData.find(item => item.id === notification.analysisId);

            // إنشاء نافذة منبثقة لعرض التحليل
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>📊 تفاصيل التحليل من المحلل الأول</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        
                        <!-- معلومات التحليل -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">📋 معلومات التحليل</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div><strong>رقم التحليل:</strong> ${notification.analysisId || 'غير محدد'}</div>
                                <div><strong>تاريخ الإرسال:</strong> ${notification.time}</div>
                                <div><strong>المحلل:</strong> ${notification.source}</div>
                                <div><strong>الحالة:</strong> <span style="color: #27ae60;">مرسل</span></div>
                            </div>
                        </div>

                        <!-- نص التحليل -->
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="color: #27ae60; margin-bottom: 10px;">📝 التحليل</h4>
                            <div style="line-height: 1.6; white-space: pre-wrap;">${notification.fullContent || notification.content}</div>
                        </div>

                        <!-- التوصيات -->
                        ${notification.recommendations ? `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="color: #856404; margin-bottom: 10px;">💡 التوصيات</h4>
                            <div style="line-height: 1.6; white-space: pre-wrap;">${notification.recommendations}</div>
                        </div>
                        ` : ''}

                        <!-- الرصد المعتمد عليه -->
                        ${relatedMonitoring ? `
                        <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="color: #0c5460; margin-bottom: 15px;">📊 الرصد المعتمد عليه في التحليل</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div><strong>المصدر:</strong> ${relatedMonitoring.source}</div>
                                <div><strong>التاريخ:</strong> ${relatedMonitoring.date}</div>
                                <div><strong>نوع الرصد:</strong> ${relatedMonitoring.monitoringType || 'غير محدد'}</div>
                                <div><strong>الأولوية:</strong> <span class="priority-badge priority-${relatedMonitoring.priority === 'عالي' ? 'high' : relatedMonitoring.priority === 'متوسط' ? 'medium' : 'low'}">${relatedMonitoring.priority}</span></div>
                            </div>

                            <div style="margin-bottom: 10px;">
                                <strong>العنوان:</strong> ${relatedMonitoring.title || 'غير محدد'}
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <strong>المحتوى المرصود:</strong>
                                <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 5px; line-height: 1.6;">
                                    ${relatedMonitoring.content}
                                </div>
                            </div>

                            ${relatedMonitoring.link ? `
                            <div style="margin-bottom: 10px;">
                                <strong>الرابط:</strong> <a href="${relatedMonitoring.link}" target="_blank" style="color: #007bff;">عرض المصدر الأصلي</a>
                            </div>
                            ` : ''}
                        </div>
                        ` : `
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="color: #721c24; margin-bottom: 10px;">⚠️ الرصد المعتمد عليه</h4>
                            <p>لم يتم العثور على البيانات المرصودة المرتبطة بهذا التحليل.</p>
                        </div>
                        `}

                        <!-- أزرار الإجراءات -->
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                            <button class="action-btn approve" onclick="approveDirective(${notificationId}, this); this.closest('.modal').remove();">موافقة على التحليل</button>
                            <button class="action-btn reject" onclick="rejectDirective(${notificationId}, this); this.closest('.modal').remove();">رفض التحليل</button>
                            <button class="action-btn consult" onclick="requestConsultation(${notificationId}, this); this.closest('.modal').remove();">استشارة خارجية</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            // إضافة تأثير الظهور
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }

        // ===== دوال مسؤولي المسارات =====

        // تحميل الموجهات المرسلة لمسار معين
        function loadPathDirectives(pathName) {
            const pathDirectives = JSON.parse(localStorage.getItem('pathDirectives') || '[]');
            const myDirectives = pathDirectives.filter(directive => directive.path === pathName);
            
            const directivesList = document.getElementById('receivedDirectivesList');
            if (directivesList) {
                if (myDirectives.length === 0) {
                    directivesList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">لا توجد موجهات مستلمة حتى الآن</p>';
                } else {
                    directivesList.innerHTML = myDirectives.map(directive => `
                        <div class="directive-item" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="color: #2c3e50; margin: 0;">موجه رقم: ${directive.id}</h4>
                                <span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${directive.status === 'pending' ? 'قيد المعالجة' : 'مكتمل'}</span>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                <strong>المحتوى:</strong>
                                <div style="margin-top: 5px; line-height: 1.6;">${directive.content}</div>
                            </div>
                            ${directive.recommendations ? `
                            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                <strong>التوصيات:</strong>
                                <div style="margin-top: 5px; line-height: 1.6;">${directive.recommendations}</div>
                            </div>
                            ` : ''}
                            <div style="font-size: 12px; color: #6c757d;">
                                تاريخ الاستلام: ${new Date(directive.timestamp).toLocaleString('ar-SA')}
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        // تحديث قائمة مستوى النشر في نموذج التكليف
        function updateAssignmentPublishLevelOptions() {
            const publishLevels = JSON.parse(localStorage.getItem('customPublishLevels') || '[]');
            
            // تحديث جميع قوائم مستوى النشر في نماذج مسؤولي المسارات
            const selects = document.querySelectorAll('.assignment-form select[required]');
            
            selects.forEach(select => {
                // التحقق من أن هذا حقل مستوى النشر
                const label = select.parentElement.querySelector('label');
                if (label && label.textContent.includes('مستوى النشر')) {
                    // مسح الخيارات الموجودة
                    select.innerHTML = '<option value="">اختر مستوى النشر</option>';
                    
                    // إضافة مستويات النشر المضافة
                    publishLevels.forEach(level => {
                        const option = document.createElement('option');
                        option.value = level.name;
                        option.textContent = level.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // دالة تحديث قوائم الوسائل للنماذج الجديدة
        function updateMediaOptionsNew(selectElement) {
            const mediaType = selectElement.value;
            
            // البحث عن قائمة الوسيلة في نفس النموذج
            let specificMediaSelect = null;
            
            // البحث في البطاقة الحالية
            const assignmentCard = selectElement.closest('.assignment-card');
            if (assignmentCard) {
                specificMediaSelect = assignmentCard.querySelector('.specific-media-select');
            }
            
            // إذا لم نجدها، ابحث في النموذج العام
            if (!specificMediaSelect) {
                const formGroup = selectElement.closest('.assignment-form');
                if (formGroup) {
                    specificMediaSelect = formGroup.querySelector('.specific-media-select');
                }
            }
            
            // إذا لم نجدها بعد، ابحث في العنصر التالي
            if (!specificMediaSelect) {
                const nextFormGroup = selectElement.closest('.form-group').parentElement.nextElementSibling;
                if (nextFormGroup) {
                    specificMediaSelect = nextFormGroup.querySelector('select');
                }
            }
            
            if (!specificMediaSelect) {
                console.log('لم يتم العثور على قائمة الوسيلة');
                return;
            }
            
            // مسح الخيارات الموجودة
            specificMediaSelect.innerHTML = '<option value="">اختر الوسيلة</option>';
            
            if (mediaType === 'تلفزيوني') {
                // إضافة القنوات من نماذج الرصد
                const tvMonitoringData = JSON.parse(localStorage.getItem('tvMonitoringData') || '[]');
                const uniqueChannels = [...new Set(tvMonitoringData.map(item => item.channel))].filter(channel => channel);
                
                uniqueChannels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel;
                    option.textContent = channel;
                    specificMediaSelect.appendChild(option);
                });
                
                // إضافة القنوات من إدارة الوسائل كبديل
                const customChannels = JSON.parse(localStorage.getItem('customChannels') || '[]');
                customChannels.forEach(channel => {
                    // تجنب التكرار
                    if (!uniqueChannels.includes(channel.name)) {
                        const option = document.createElement('option');
                        option.value = channel.name;
                        option.textContent = channel.name;
                        specificMediaSelect.appendChild(option);
                    }
                });
                
            } else if (mediaType === 'موقع') {
                // إضافة المواقع من نماذج الرصد
                const webMonitoringData = JSON.parse(localStorage.getItem('webMonitoringData') || '[]');
                const uniqueWebsites = [...new Set(webMonitoringData.map(item => item.website))].filter(website => website);
                
                uniqueWebsites.forEach(website => {
                    const option = document.createElement('option');
                    option.value = website;
                    option.textContent = website;
                    specificMediaSelect.appendChild(option);
                });
                
                // إضافة المواقع من إدارة الوسائل كبديل
                const customWebsites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
                customWebsites.forEach(website => {
                    // تجنب التكرار
                    if (!uniqueWebsites.includes(website.name)) {
                        const option = document.createElement('option');
                        option.value = website.name;
                        option.textContent = website.name;
                        specificMediaSelect.appendChild(option);
                    }
                });
                
            } else if (mediaType === 'شبكات') {
                // إضافة الشبكات الاجتماعية من نماذج الرصد
                const socialMonitoringData = JSON.parse(localStorage.getItem('socialMonitoringData') || '[]');
                const uniquePlatforms = [...new Set(socialMonitoringData.map(item => item.platform))].filter(platform => platform);
                
                uniquePlatforms.forEach(platform => {
                    const option = document.createElement('option');
                    option.value = platform;
                    option.textContent = platform;
                    specificMediaSelect.appendChild(option);
                });
                
                // إضافة منصات افتراضية إذا لم توجد بيانات
                if (uniquePlatforms.length === 0) {
                    const defaultPlatforms = ['تويتر', 'فيسبوك', 'إنستغرام', 'يوتيوب', 'تيك توك', 'لينكد إن', 'سناب شات', 'تيليجرام'];
                    defaultPlatforms.forEach(platform => {
                        const option = document.createElement('option');
                        option.value = platform;
                        option.textContent = platform;
                        specificMediaSelect.appendChild(option);
                    });
                }
            }
            
            console.log(`تم تحديث قائمة الوسائل لنوع: ${mediaType} من نماذج الرصد`);
        }

        // تحديث قائمة الوسائل بناءً على نوع الوسيلة المختار
        function updateMediaOptions() {
            const mediaType = document.getElementById('mediaType').value;
            const specificMediaSelect = document.getElementById('specificMedia');
            
            if (!specificMediaSelect) return;
            
            // مسح الخيارات الموجودة
            specificMediaSelect.innerHTML = '<option value="">اختر الوسيلة</option>';
            
            if (mediaType === 'تلفزيوني') {
                // إضافة القنوات التلفزيونية
                const channels = JSON.parse(localStorage.getItem('customChannels') || '[]');
                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.name;
                    option.textContent = channel.name;
                    specificMediaSelect.appendChild(option);
                });
            } else if (mediaType === 'موقع') {
                // إضافة المواقع الإلكترونية
                const websites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
                websites.forEach(website => {
                    const option = document.createElement('option');
                    option.value = website.name;
                    option.textContent = website.name;
                    specificMediaSelect.appendChild(option);
                });
            } else if (mediaType === 'شبكات') {
                // إضافة منصات التواصل الاجتماعي
                const socialPlatforms = ['تويتر', 'فيسبوك', 'إنستغرام', 'يوتيوب', 'تيك توك', 'لينكد إن', 'سناب شات', 'تيليجرام'];
                socialPlatforms.forEach(platform => {
                    const option = document.createElement('option');
                    option.value = platform;
                    option.textContent = platform;
                    specificMediaSelect.appendChild(option);
                });
            }
        }

        // إرسال التكليف
        function submitAssignment(event) {
            event.preventDefault();
            
            const assignmentText = document.getElementById('assignmentText').value;
            const executingEntity = document.getElementById('executingEntity').value;
            const executionTime = document.getElementById('executionTime').value;
            const publishLevel = document.getElementById('assignmentPublishLevel').value;
            const mediaType = document.getElementById('mediaType').value;
            const specificMedia = document.getElementById('specificMedia').value;
            
            if (!assignmentText || !executingEntity || !executionTime || !publishLevel || !mediaType || !specificMedia) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            // إنشاء التكليف
            const assignment = {
                id: Date.now(),
                text: assignmentText,
                executingEntity: executingEntity,
                executionTime: executionTime,
                publishLevel: publishLevel,
                mediaType: mediaType,
                specificMedia: specificMedia,
                timestamp: new Date().toISOString(),
                status: 'draft'
            };
            
            // حفظ التكليف في قائمة التكاليف المؤقتة
            let tempAssignments = JSON.parse(localStorage.getItem('tempAssignments') || '[]');
            tempAssignments.push(assignment);
            localStorage.setItem('tempAssignments', JSON.stringify(tempAssignments));
            
            // عرض التكليف في القائمة
            displayAssignments();
            
            // مسح النموذج
            clearAssignmentForm();
            
            showNotification('تم إضافة التكليف بنجاح');
        }

        // عرض التكاليف المضافة
        function displayAssignments() {
            const tempAssignments = JSON.parse(localStorage.getItem('tempAssignments') || '[]');
            const assignmentsList = document.getElementById('assignmentsList');
            
            if (assignmentsList) {
                if (tempAssignments.length === 0) {
                    assignmentsList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">لم يتم إضافة أي تكاليف بعد</p>';
                } else {
                    assignmentsList.innerHTML = tempAssignments.map((assignment, index) => `
                        <div class="assignment-item" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="color: #2c3e50; margin: 0;">تكليف رقم: ${assignment.id}</h4>
                                <button onclick="removeAssignment(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">حذف</button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div><strong>الجهة المنفذة:</strong> ${assignment.executingEntity}</div>
                                <div><strong>زمن التنفيذ:</strong> ${new Date(assignment.executionTime).toLocaleString('ar-SA')}</div>
                                <div><strong>مستوى النشر:</strong> ${assignment.publishLevel}</div>
                                <div><strong>نوع الوسيلة:</strong> ${assignment.mediaType}</div>
                                <div><strong>الوسيلة:</strong> ${assignment.specificMedia}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                <strong>نص التكليف:</strong>
                                <div style="margin-top: 5px; line-height: 1.6;">${assignment.text}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        // حذف تكليف
        function removeAssignment(index) {
            let tempAssignments = JSON.parse(localStorage.getItem('tempAssignments') || '[]');
            tempAssignments.splice(index, 1);
            localStorage.setItem('tempAssignments', JSON.stringify(tempAssignments));
            displayAssignments();
            showNotification('تم حذف التكليف');
        }

        // مسح نموذج التكليف
        function clearAssignmentForm() {
            document.getElementById('assignmentText').value = '';
            document.getElementById('executingEntity').value = '';
            document.getElementById('executionTime').value = '';
            document.getElementById('assignmentPublishLevel').value = '';
            document.getElementById('mediaType').value = '';
            document.getElementById('specificMedia').value = '';
        }

        // إرسال جميع التكاليف
        function submitAllAssignments() {
            const tempAssignments = JSON.parse(localStorage.getItem('tempAssignments') || '[]');
            
            if (tempAssignments.length === 0) {
                showNotification('لا توجد تكاليف لإرسالها', 'error');
                return;
            }
            
            // تحويل التكاليف إلى حالة "مرسل"
            const finalAssignments = tempAssignments.map(assignment => ({
                ...assignment,
                status: 'sent',
                sentTimestamp: new Date().toISOString()
            }));
            
            // حفظ التكاليف النهائية
            let allAssignments = JSON.parse(localStorage.getItem('allAssignments') || '[]');
            allAssignments.push(...finalAssignments);
            localStorage.setItem('allAssignments', JSON.stringify(allAssignments));
            
            // مسح التكاليف المؤقتة
            localStorage.removeItem('tempAssignments');
            
            // تحديث العرض
            displayAssignments();
            
            showNotification(`تم إرسال ${finalAssignments.length} تكليف بنجاح`);
        }

        // دوال واجهة مسؤولي المسارات الجديدة
        let assignmentCounter = 1;

        function addNewAssignment() {
            assignmentCounter++;
            const container = document.getElementById('assignmentsContainer');
            
            const newAssignmentHTML = `
                <div class="assignment-card" id="assignment-${assignmentCounter}">
                    <div class="assignment-header">
                        <h4 class="assignment-title">التكليف ${assignmentCounter}</h4>
                        <button type="button" class="delete-assignment-btn" onclick="deleteAssignment(${assignmentCounter})">
                            🗑️ حذف
                        </button>
                    </div>
                    <div class="assignment-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">نص التكليف:</label>
                                <textarea class="form-textarea" rows="3" placeholder="اكتب نص التكليف هنا..." required></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">الجهة المنفذة:</label>
                                <input type="text" class="form-input" placeholder="أدخل اسم الجهة المنفذة" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label class="form-label">زمن التنفيذ:</label>
                                <input type="datetime-local" class="form-input" required>
                            </div>
                            <div class="form-group half-width">
                                <label class="form-label">مستوى النشر:</label>
                                <select class="form-select" required>
                                    <option value="">اختر مستوى النشر</option>
                                    <!-- سيتم تحديث هذه القائمة من إدارة الرصد -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label class="form-label">نوع الوسيلة:</label>
                                <select class="form-select media-type-select" onchange="updateMediaOptionsNew(this)" required>
                                    <option value="">اختر نوع الوسيلة</option>
                                    <option value="تلفزيوني">تلفزيوني</option>
                                    <option value="موقع">موقع</option>
                                    <option value="شبكات اجتماعية">شبكات اجتماعية</option>
                                </select>
                            </div>
                            <div class="form-group half-width">
                                <label class="form-label">الوسيلة:</label>
                                <select class="form-select specific-media-select" required>
                                    <option value="">اختر الوسيلة</option>
                                    <!-- سيتم تحديث هذه القائمة بناءً على نوع الوسيلة -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newAssignmentHTML);
            
            // تحديث قوائم مستوى النشر للتكليف الجديد
            updatePublishLevelOptionsForNewAssignment(assignmentCounter);
            
            // تمرير سلس للتكليف الجديد
            document.getElementById(`assignment-${assignmentCounter}`).scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }

        function deleteAssignment(assignmentId) {
            if (assignmentId === 1) {
                showNotification('لا يمكن حذف التكليف الأول', 'error');
                return;
            }
            
            const assignmentCard = document.getElementById(`assignment-${assignmentId}`);
            if (assignmentCard) {
                assignmentCard.style.transform = 'scale(0.8)';
                assignmentCard.style.opacity = '0';
                
                setTimeout(() => {
                    assignmentCard.remove();
                    showNotification('تم حذف التكليف بنجاح');
                }, 300);
            }
        }

        function updateMediaOptionsNew(selectElement) {
            try {
                const assignmentCard = selectElement.closest('.assignment-card');
                if (!assignmentCard) {
                    console.error('Assignment card not found');
                    return;
                }
                
                const specificMediaSelect = assignmentCard.querySelector('.specific-media-select');
                if (!specificMediaSelect) {
                    console.error('Specific media select not found');
                    return;
                }
                
                const mediaType = selectElement.value;
                console.log('Media type selected:', mediaType);
                
                // مسح الخيارات الحالية
                specificMediaSelect.innerHTML = '<option value="">اختر الوسيلة</option>';
                
                if (mediaType === 'تلفزيوني') {
                    // استدعاء القنوات من إدارة الوسائل
                    const channels = JSON.parse(localStorage.getItem('channels') || '[]');
                    console.log('Channels found:', channels);
                    channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.name;
                        option.textContent = channel.name;
                        specificMediaSelect.appendChild(option);
                    });
                } else if (mediaType === 'موقع') {
                    // استدعاء المواقع من إدارة الوسائل
                    const websites = JSON.parse(localStorage.getItem('websites') || '[]');
                    console.log('Websites found:', websites);
                    websites.forEach(website => {
                        const option = document.createElement('option');
                        option.value = website.name;
                        option.textContent = website.name;
                        specificMediaSelect.appendChild(option);
                    });
                } else if (mediaType === 'شبكات اجتماعية') {
                    // كتابة "ناشطين" تلقائياً
                    const option = document.createElement('option');
                    option.value = 'ناشطين';
                    option.textContent = 'ناشطين';
                    option.selected = true;
                    specificMediaSelect.appendChild(option);
                    console.log('Added ناشطين option');
                }
            } catch (error) {
                console.error('Error in updateMediaOptionsNew:', error);
            }
        }

        function updatePublishLevelOptionsForNewAssignment(assignmentId) {
            const assignmentCard = document.getElementById(`assignment-${assignmentId}`);
            const publishLevelSelect = assignmentCard.querySelector('.form-select');
            
            // تحديث قائمة مستوى النشر
            const publishLevels = JSON.parse(localStorage.getItem('customPublishLevels') || '[]');
            publishLevelSelect.innerHTML = '<option value="">اختر مستوى النشر</option>';
            
            publishLevels.forEach(level => {
                const option = document.createElement('option');
                option.value = level.name;
                option.textContent = level.name;
                publishLevelSelect.appendChild(option);
            });
        }

        function collectAllAssignments() {
            const assignments = [];
            const assignmentCards = document.querySelectorAll('.assignment-card');
            
            assignmentCards.forEach((card, index) => {
                const textarea = card.querySelector('.form-textarea');
                const executingEntity = card.querySelector('.form-input[placeholder*="الجهة"]');
                const executionTime = card.querySelector('input[type="datetime-local"]');
                const publishLevel = card.querySelector('.form-select');
                const mediaType = card.querySelector('.media-type-select');
                const specificMedia = card.querySelector('.specific-media-select');
                
                if (textarea.value && executingEntity.value && executionTime.value && 
                    publishLevel.value && mediaType.value && specificMedia.value) {
                    
                    assignments.push({
                        id: Date.now() + index,
                        text: textarea.value,
                        executingEntity: executingEntity.value,
                        executionTime: executionTime.value,
                        publishLevel: publishLevel.value,
                        mediaType: mediaType.value,
                        specificMedia: specificMedia.value,
                        pathManager: currentUser.name,
                        path: currentUser.path,
                        createdAt: new Date().toISOString()
                    });
                }
            });
            
            return assignments;
        }

        // تحديث دالة submitAllAssignments للعمل مع التصميم الجديد
        function submitAllAssignments() {
            const assignments = collectAllAssignments();
            
            if (assignments.length === 0) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            // حفظ التكاليف
            let allAssignments = JSON.parse(localStorage.getItem('allAssignments') || '[]');
            allAssignments.push(...assignments);
            localStorage.setItem('allAssignments', JSON.stringify(allAssignments));
            
            // إرسال التكاليف إلى صندوق الوارد للمدير
            let directorInbox = JSON.parse(localStorage.getItem('directorInbox') || '[]');
            
            assignments.forEach(assignment => {
                directorInbox.push({
                    id: assignment.id,
                    type: 'assignment',
                    title: `تكليف جديد من ${assignment.pathManager}`,
                    content: assignment.text,
                    details: {
                        executingEntity: assignment.executingEntity,
                        executionTime: assignment.executionTime,
                        publishLevel: assignment.publishLevel,
                        mediaType: assignment.mediaType,
                        specificMedia: assignment.specificMedia,
                        pathManager: assignment.pathManager,
                        path: assignment.path
                    },
                    timestamp: assignment.createdAt,
                    status: 'pending',
                    sender: assignment.pathManager,
                    senderType: 'path_manager'
                });
            });
            
            localStorage.setItem('directorInbox', JSON.stringify(directorInbox));
            
            // مسح النماذج
            document.querySelectorAll('.assignment-card').forEach((card, index) => {
                if (index === 0) {
                    // إعادة تعيين التكليف الأول
                    card.querySelectorAll('input, textarea, select').forEach(input => {
                        input.value = '';
                    });
                } else {
                    // حذف التكاليف الإضافية
                    card.remove();
                }
            });
            
            assignmentCounter = 1;
            
            showNotification(`تم إرسال ${assignments.length} تكليف إلى صندوق الوارد بنجاح`);
        }

        // دوال إدارة التكاليف للمدير
        function approveAssignment(assignmentId, button) {
            // تحديث حالة التكليف
            let directorInbox = JSON.parse(localStorage.getItem('directorInbox') || '[]');
            const assignmentIndex = directorInbox.findIndex(item => item.id == assignmentId);
            
            if (assignmentIndex !== -1) {
                directorInbox[assignmentIndex].status = 'approved';
                localStorage.setItem('directorInbox', JSON.stringify(directorInbox));
                
                // تحديث واجهة المستخدم
                const notificationItem = button.closest('.notification-item');
                notificationItem.style.background = '#e8f5e9';
                notificationItem.querySelector('.notification-actions').innerHTML = 
                    '<span style="color: #2e7d32; font-weight: bold;">✅ تم إقرار التكليف</span>';
                
                showNotification('تم إقرار التكليف بنجاح');
            }
        }

        function rejectAssignment(assignmentId, button) {
            // تحديث حالة التكليف
            let directorInbox = JSON.parse(localStorage.getItem('directorInbox') || '[]');
            const assignmentIndex = directorInbox.findIndex(item => item.id == assignmentId);
            
            if (assignmentIndex !== -1) {
                directorInbox[assignmentIndex].status = 'rejected';
                localStorage.setItem('directorInbox', JSON.stringify(directorInbox));
                
                // تحديث واجهة المستخدم
                const notificationItem = button.closest('.notification-item');
                notificationItem.style.background = '#ffebee';
                notificationItem.querySelector('.notification-actions').innerHTML = 
                    '<span style="color: #c62828; font-weight: bold;">❌ تم رفض التكليف</span>';
                
                showNotification('تم رفض التكليف');
            }
        }

        function requestAssignmentModification(assignmentId, button) {
            const reason = prompt('يرجى إدخال سبب طلب التعديل:');
            if (reason) {
                // تحديث حالة التكليف
                let directorInbox = JSON.parse(localStorage.getItem('directorInbox') || '[]');
                const assignmentIndex = directorInbox.findIndex(item => item.id == assignmentId);
                
                if (assignmentIndex !== -1) {
                    directorInbox[assignmentIndex].status = 'modification_requested';
                    directorInbox[assignmentIndex].modificationReason = reason;
                    localStorage.setItem('directorInbox', JSON.stringify(directorInbox));
                    
                    // تحديث واجهة المستخدم
                    const notificationItem = button.closest('.notification-item');
                    notificationItem.style.background = '#fff3e0';
                    notificationItem.querySelector('.notification-actions').innerHTML = 
                        `<span style="color: #ef6c00; font-weight: bold;">⚠️ تم طلب التعديل: ${reason}</span>`;
                    
                    showNotification('تم إرسال طلب التعديل');
                }
            }
        }
    </script>

    <!-- Notification Toast -->
    <div id="notificationToast" class="toast">
        <div class="toast-content">
            <span id="toastMessage"></span>
        </div>
    </div>

    <style>
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 10000;
            max-width: 300px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #4CAF50;
        }

        .toast.error {
            background: #f44336;
        }

        .toast.warning {
            background: #ff9800;
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
    
    <!-- Notification Container -->
    <div id="notificationContainer"></div>

</body>
</html>

